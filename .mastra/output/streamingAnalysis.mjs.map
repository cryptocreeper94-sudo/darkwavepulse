{"version":3,"file":"streamingAnalysis.mjs","sources":["../../src/mastra/ai/streamingAnalysis.ts"],"sourcesContent":["import { createOpenAI } from \"@ai-sdk/openai\";\nimport { createAnthropic } from \"@ai-sdk/anthropic\";\nimport { streamText } from \"ai\";\n\nconst openai = createOpenAI({\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n});\n\nconst anthropic = createAnthropic({\n  baseURL: process.env.AI_INTEGRATIONS_ANTHROPIC_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_ANTHROPIC_API_KEY,\n});\n\nexport interface StreamingAnalysisOptions {\n  ticker: string;\n  analysisType: 'technical' | 'fundamental' | 'sentiment' | 'full';\n  provider?: 'openai' | 'claude';\n  personality?: string;\n}\n\nexport async function* streamAnalysis(\n  options: StreamingAnalysisOptions\n): AsyncGenerator<string, void, unknown> {\n  const { ticker, analysisType, provider = 'openai', personality } = options;\n  \n  const systemPrompt = `You are an expert trading analyst providing real-time analysis for ${ticker}.\n${personality ? `Personality: ${personality}` : ''}\n\nProvide ${analysisType} analysis in a streaming format, delivering insights as they're computed.\nUse markdown formatting with bold headers and bullet points.\nInclude specific numbers, percentages, and actionable recommendations.`;\n\n  const userPrompt = `Analyze ${ticker} with ${analysisType} analysis. Stream your insights in real-time.`;\n\n  try {\n    const model = provider === 'claude' \n      ? anthropic(\"claude-sonnet-4-5\")\n      : openai(\"gpt-4o\");\n\n    const result = streamText({\n      model: model as any,\n      system: systemPrompt,\n      prompt: userPrompt,\n    });\n\n    for await (const chunk of result.textStream) {\n      yield chunk;\n    }\n  } catch (error: any) {\n    if (provider === 'claude') {\n      try {\n        const fallbackResult = streamText({\n          model: openai(\"gpt-4o\") as any,\n          system: systemPrompt,\n          prompt: userPrompt,\n        });\n        \n        yield \"[Fallback to OpenAI] \";\n        for await (const chunk of fallbackResult.textStream) {\n          yield chunk;\n        }\n      } catch (fallbackError) {\n        yield `Error: Both providers failed - ${error.message}`;\n      }\n    } else {\n      yield `Error streaming analysis: ${error.message}`;\n    }\n  }\n}\n\nexport async function streamMultiModelAnalysis(\n  ticker: string,\n  onChunk: (chunk: string, source: string) => void\n): Promise<{ openai: string; claude: string; consensus: string }> {\n  const results = {\n    openai: '',\n    claude: '',\n    consensus: ''\n  };\n\n  const systemPrompt = `You are an expert trading analyst. Provide concise technical analysis for ${ticker}.\nInclude: Current trend, key levels, RSI assessment, MACD signal, and recommendation (BUY/SELL/HOLD).\nKeep response under 200 words.`;\n\n  const openaiPromise = (async () => {\n    try {\n      const result = streamText({\n        model: openai(\"gpt-4o\") as any,\n        system: systemPrompt,\n        prompt: `Analyze ${ticker}`,\n      });\n      for await (const chunk of result.textStream) {\n        results.openai += chunk;\n        onChunk(chunk, 'openai');\n      }\n    } catch (error: any) {\n      results.openai = `[OpenAI Error: ${error.message}]`;\n      onChunk(results.openai, 'openai');\n    }\n  })();\n  \n  const claudePromise = (async () => {\n    try {\n      const result = streamText({\n        model: anthropic(\"claude-sonnet-4-5\") as any,\n        system: systemPrompt,\n        prompt: `Analyze ${ticker}`,\n      });\n      for await (const chunk of result.textStream) {\n        results.claude += chunk;\n        onChunk(chunk, 'claude');\n      }\n    } catch (error: any) {\n      results.claude = `[Claude Error: ${error.message}]`;\n      onChunk(results.claude, 'claude');\n    }\n  })();\n\n  await Promise.all([openaiPromise, claudePromise]);\n\n  if (results.openai && results.claude && \n      !results.openai.startsWith('[') && !results.claude.startsWith('[')) {\n    try {\n      const consensusResult = streamText({\n        model: anthropic(\"claude-sonnet-4-5\") as any,\n        system: \"You are a meta-analyst. Given two AI analyses, synthesize a consensus view.\",\n        prompt: `OpenAI Analysis:\\n${results.openai}\\n\\nClaude Analysis:\\n${results.claude}\\n\\nProvide a brief consensus analysis combining both perspectives.`,\n      });\n\n      for await (const chunk of consensusResult.textStream) {\n        results.consensus += chunk;\n        onChunk(chunk, 'consensus');\n      }\n    } catch (error: any) {\n      results.consensus = results.openai || results.claude;\n      onChunk(\"[Using single model result as consensus]\", 'consensus');\n    }\n  } else {\n    results.consensus = results.openai || results.claude || \"Unable to generate analysis\";\n    onChunk(\"[Using available result as consensus]\", 'consensus');\n  }\n\n  return results;\n}\n\nexport interface RealTimeMarketData {\n  ticker: string;\n  price: number;\n  change24h: number;\n  volume: number;\n  rsi?: number;\n  macd?: { value: number; signal: number; histogram: number };\n}\n\nexport async function* streamLiveAnalysis(\n  marketData: RealTimeMarketData,\n  previousAnalysis?: string\n): AsyncGenerator<string, void, unknown> {\n  const prompt = `\nLIVE MARKET UPDATE for ${marketData.ticker}:\n- Price: $${marketData.price.toFixed(2)}\n- 24h Change: ${marketData.change24h >= 0 ? '+' : ''}${marketData.change24h.toFixed(2)}%\n- Volume: $${(marketData.volume / 1_000_000).toFixed(2)}M\n${marketData.rsi ? `- RSI(14): ${marketData.rsi.toFixed(1)}` : ''}\n${marketData.macd ? `- MACD: ${marketData.macd.value.toFixed(4)}` : ''}\n\n${previousAnalysis ? `Previous Analysis Summary: ${previousAnalysis}` : ''}\n\nProvide real-time commentary on this data. Be concise and actionable.`;\n\n  try {\n    const result = streamText({\n      model: openai(\"gpt-4o-mini\") as any,\n      system: \"You are a real-time market commentator. Provide brief, punchy analysis updates.\",\n      prompt,\n    });\n\n    for await (const chunk of result.textStream) {\n      yield chunk;\n    }\n  } catch (error: any) {\n    yield `Error: ${error.message}`;\n  }\n}\n"],"names":[],"mappings":"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"}