{"version":3,"file":"b34003c7-1647-42bd-ae1e-90b067c28951.mjs","sources":["../../../src/mastra/tools/preferencesTool.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\n\n/**\n * Preferences Tool - Manages user preferences for link destinations\n * Stores preferences in database per user\n */\n\nexport const preferencesTool = createTool({\n  id: \"preferences-tool\",\n  description: \"Manages user preferences for external link destinations (Kraken vs CoinGecko/Yahoo Finance).\",\n\n  inputSchema: z.object({\n    action: z.enum(['set', 'get']).describe(\"Action to perform on preferences\"),\n    linkPreference: z.enum(['default', 'kraken']).optional().describe(\"Link preference: 'default' (CoinGecko/Yahoo) or 'kraken'\"),\n    userId: z.string().optional().describe(\"User ID for personalized storage\"),\n  }),\n\n  outputSchema: z.object({\n    success: z.boolean(),\n    linkPreference: z.string(),\n    message: z.string(),\n  }),\n\n  execute: async ({ context, mastra, runtimeContext }) => {\n    const logger = mastra?.getLogger();\n    logger?.info('üîß [PreferencesTool] Starting execution', { action: context.action });\n\n    // Get userId from context\n    const userId = context.userId || (runtimeContext as any)?.resourceId || 'default-user';\n    const PREFS_KEY = `user_preferences_${userId}`;\n\n    logger?.info('üìù [PreferencesTool] User context', { userId, prefsKey: PREFS_KEY });\n\n    try {\n      // Get current preferences from memory storage (PostgreSQL-backed)\n      let currentPref = 'default'; // Default to CoinGecko/Yahoo Finance\n      \n      try {\n        const memory = mastra?.memory;\n        if (memory) {\n          const messages = await memory.getMessages({\n            resourceId: userId,\n            threadId: PREFS_KEY,\n          });\n          \n          if (messages && messages.length > 0) {\n            const lastMessage = messages[messages.length - 1];\n            if (lastMessage.content) {\n              const prefs = JSON.parse(lastMessage.content as string);\n              currentPref = prefs.linkPreference || 'default';\n            }\n          }\n        }\n      } catch (e) {\n        logger?.info('[PreferencesTool] No existing preferences found, using defaults');\n        currentPref = 'default';\n      }\n\n      let message = '';\n      let success = true;\n\n      if (context.action === 'set' && context.linkPreference) {\n        currentPref = context.linkPreference;\n        \n        // Save updated preferences to memory\n        const memory = mastra?.memory;\n        if (memory) {\n          await memory.saveMessages({\n            messages: [{\n              role: 'assistant',\n              content: JSON.stringify({ linkPreference: currentPref }),\n            }],\n            resourceId: userId,\n            threadId: PREFS_KEY,\n          });\n          logger?.info('üíæ [PreferencesTool] Preferences saved', { userId, linkPreference: currentPref });\n        }\n\n        message = currentPref === 'kraken' \n          ? '‚úÖ Links set to Kraken (crypto & stocks will link to kraken.com)'\n          : '‚úÖ Links set to default (crypto‚ÜíCoinGecko, stocks‚ÜíYahoo Finance)';\n      } else {\n        message = currentPref === 'kraken'\n          ? 'Current link preference: Kraken'\n          : 'Current link preference: Default (CoinGecko/Yahoo Finance)';\n      }\n\n      logger?.info('‚úÖ [PreferencesTool] Action completed', { \n        action: context.action,\n        userId,\n        linkPreference: currentPref\n      });\n\n      return {\n        success,\n        linkPreference: currentPref,\n        message,\n      };\n    } catch (error: any) {\n      logger?.error('‚ùå [PreferencesTool] Error', { error: error.message });\n      throw new Error(`Preferences operation failed: ${error.message}`);\n    }\n  },\n});\n"],"names":[],"mappings":"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"}