{"version":3,"file":"9dc829a4-ce50-4203-b8fc-4df9a4208787.mjs","sources":["../../../src/mastra/tools/subscriptionTool.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\nimport Stripe from \"stripe\";\nimport { db } from \"../../db/client.js\";\nimport { subscriptions, userUsage } from \"../../db/schema.js\";\nimport { eq } from \"drizzle-orm\";\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY || \"\");\n\nexport const subscriptionTool = createTool({\n  id: \"subscription-management\",\n  description:\n    \"Manages user subscriptions including creating checkout sessions, checking subscription status, and handling cancellations. Use this when users want to upgrade to premium, check their subscription status, or cancel their subscription.\",\n  inputSchema: z.object({\n    action: z.enum([\n      \"create_checkout\",\n      \"check_status\",\n      \"cancel\",\n      \"verify_payment\",\n    ]),\n    userId: z.string().describe(\"Telegram user ID\"),\n    plan: z\n      .enum([\"basic\", \"premium\"])\n      .optional()\n      .describe(\"Subscription plan: basic ($2/mo, 20 searches/day) or premium ($5/mo, unlimited). Defaults to premium\"),\n    returnUrl: z\n      .string()\n      .optional()\n      .describe(\"URL to return after checkout (required for create_checkout)\"),\n  }),\n  outputSchema: z.object({\n    success: z.boolean(),\n    message: z.string(),\n    checkoutUrl: z.string().optional(),\n    subscription: z\n      .object({\n        plan: z.string(),\n        status: z.string(),\n        provider: z.string().nullable(),\n        expiryDate: z.string().nullable(),\n        autoRenew: z.boolean(),\n      })\n      .optional(),\n  }),\n  execute: async ({ context, mastra, runtimeContext }) => {\n    const logger = mastra?.getLogger();\n    const { action, userId, plan = \"premium\", returnUrl } = context;\n    \n    logger?.info(\"üí≥ [SubscriptionTool] Starting execution\", {\n      action,\n      userId,\n    });\n\n    try {\n      switch (action) {\n        case \"create_checkout\": {\n          if (!returnUrl) {\n            return {\n              success: false,\n              message: \"Return URL is required for checkout creation\",\n            };\n          }\n\n          logger?.info(\"üõí [SubscriptionTool] Creating Stripe checkout session\");\n\n          // Create or get customer\n          const [existingSubscription] = await db\n            .select()\n            .from(subscriptions)\n            .where(eq(subscriptions.userId, userId));\n\n          let customerId = existingSubscription?.stripeCustomerId;\n\n          if (!customerId) {\n            const customer = await stripe.customers.create({\n              metadata: { telegramUserId: userId },\n            });\n            customerId = customer.id;\n            logger?.info(\"üë§ [SubscriptionTool] Created new Stripe customer\", {\n              customerId,\n            });\n          }\n\n          // Pricing based on plan\n          const planConfig = {\n            basic: {\n              name: \"DarkWave-V2 Basic\",\n              description: \"20 searches/day, advanced charts, price alerts\",\n              amount: 200, // $2.00\n            },\n            premium: {\n              name: \"DarkWave-V2 Premium\",\n              description: \"Unlimited searches, advanced charts, price alerts, and priority support\",\n              amount: 500, // $5.00\n            },\n          };\n\n          const selectedPlan = planConfig[plan];\n\n          // Create checkout session\n          const session = await stripe.checkout.sessions.create({\n            customer: customerId,\n            payment_method_types: [\"card\"],\n            line_items: [\n              {\n                price_data: {\n                  currency: \"usd\",\n                  product_data: {\n                    name: selectedPlan.name,\n                    description: selectedPlan.description,\n                  },\n                  unit_amount: selectedPlan.amount,\n                  recurring: {\n                    interval: \"month\",\n                  },\n                },\n                quantity: 1,\n              },\n            ],\n            mode: \"subscription\",\n            success_url: `${returnUrl}?session_id={CHECKOUT_SESSION_ID}`,\n            cancel_url: returnUrl,\n            metadata: {\n              telegramUserId: userId,\n              plan: plan, // Store which plan they selected\n            },\n          });\n\n          logger?.info(\"‚úÖ [SubscriptionTool] Checkout session created\", {\n            sessionId: session.id,\n            url: session.url,\n          });\n\n          return {\n            success: true,\n            message: \"Checkout session created successfully\",\n            checkoutUrl: session.url || undefined,\n          };\n        }\n\n        case \"check_status\": {\n          logger?.info(\"üîç [SubscriptionTool] Checking subscription status\");\n\n          const [subscription] = await db\n            .select()\n            .from(subscriptions)\n            .where(eq(subscriptions.userId, userId));\n\n          if (!subscription) {\n            // Create free tier entry\n            await db.insert(subscriptions).values({\n              userId: userId,\n              plan: \"free\",\n              status: \"inactive\",\n            });\n\n            await db.insert(userUsage).values({\n              userId: userId,\n              searchCount: 0,\n              alertCount: 0,\n            });\n\n            return {\n              success: true,\n              message: \"No active subscription\",\n              subscription: {\n                plan: \"free\",\n                status: \"inactive\",\n                provider: null,\n                expiryDate: null,\n                autoRenew: false,\n              },\n            };\n          }\n\n          // Check if subscription is expired\n          if (\n            subscription.expiryDate &&\n            new Date(subscription.expiryDate) < new Date()\n          ) {\n            await db\n              .update(subscriptions)\n              .set({ status: \"expired\" })\n              .where(eq(subscriptions.userId, userId));\n\n            subscription.status = \"expired\";\n          }\n\n          return {\n            success: true,\n            message: \"Subscription status retrieved\",\n            subscription: {\n              plan: subscription.plan,\n              status: subscription.status,\n              provider: subscription.provider,\n              expiryDate: subscription.expiryDate?.toISOString() || null,\n              autoRenew: subscription.autoRenew || false,\n            },\n          };\n        }\n\n        case \"cancel\": {\n          logger?.info(\"‚ùå [SubscriptionTool] Canceling subscription\");\n\n          const [subscription] = await db\n            .select()\n            .from(subscriptions)\n            .where(eq(subscriptions.userId, userId));\n\n          if (!subscription || subscription.status !== \"active\") {\n            return {\n              success: false,\n              message: \"No active subscription found\",\n            };\n          }\n\n          // Cancel Stripe subscription\n          if (\n            subscription.provider === \"stripe\" &&\n            subscription.stripeSubscriptionId\n          ) {\n            await stripe.subscriptions.update(\n              subscription.stripeSubscriptionId,\n              {\n                cancel_at_period_end: true,\n              }\n            );\n          }\n\n          await db\n            .update(subscriptions)\n            .set({\n              status: \"cancelled\",\n              autoRenew: false,\n              updatedAt: new Date(),\n            })\n            .where(eq(subscriptions.userId, userId));\n\n          logger?.info(\"‚úÖ [SubscriptionTool] Subscription cancelled successfully\");\n\n          return {\n            success: true,\n            message:\n              \"Subscription cancelled. You'll retain premium access until the end of your billing period.\",\n          };\n        }\n\n        case \"verify_payment\": {\n          logger?.info(\"üîê [SubscriptionTool] Verifying payment\");\n\n          // This will be called after Stripe webhook confirms payment\n          // For now, return current status\n          const [subscription] = await db\n            .select()\n            .from(subscriptions)\n            .where(eq(subscriptions.userId, userId));\n\n          return {\n            success: true,\n            message: \"Payment verification complete\",\n            subscription: subscription\n              ? {\n                  plan: subscription.plan,\n                  status: subscription.status,\n                  provider: subscription.provider,\n                  expiryDate: subscription.expiryDate?.toISOString() || null,\n                  autoRenew: subscription.autoRenew || false,\n                }\n              : undefined,\n          };\n        }\n\n        default:\n          return {\n            success: false,\n            message: \"Invalid action\",\n          };\n      }\n    } catch (error) {\n      logger?.error(\"‚ùå [SubscriptionTool] Error\", { error });\n      return {\n        success: false,\n        message: `Error: ${error instanceof Error ? error.message : \"Unknown error\"}`,\n      };\n    }\n  },\n});\n"],"names":[],"mappings":"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"}