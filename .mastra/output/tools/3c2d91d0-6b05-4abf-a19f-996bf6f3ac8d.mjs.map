{"version":3,"file":"3c2d91d0-6b05-4abf-a19f-996bf6f3ac8d.mjs","sources":["../../../src/mastra/tools/holdingsTool.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\n\n/**\n * Holdings Tool - Manages user's watchlist/portfolio\n * Stores tickers in database for tracking\n */\n\n// In-memory cache for holdings when memory is not available (API route calls)\nconst holdingsCache = new Map<string, string[]>();\n\nexport const holdingsTool = createTool({\n  id: \"holdings-tool\",\n  description: \"Manages user's watchlist. Can add, remove, list, or clear holdings. Holdings are persisted in the database per user.\",\n\n  inputSchema: z.object({\n    action: z.enum(['add', 'remove', 'list', 'clear']).describe(\"Action to perform on holdings\"),\n    ticker: z.string().optional().describe(\"Ticker symbol to add or remove\"),\n    tickers: z.array(z.string()).optional().describe(\"Multiple tickers to add at once\"),\n    userId: z.string().optional().describe(\"User ID for personalized storage\"),\n  }),\n\n  outputSchema: z.object({\n    action: z.string(),\n    success: z.boolean(),\n    holdings: z.array(z.string()),\n    message: z.string(),\n  }),\n\n  execute: async ({ context, mastra, runtimeContext }) => {\n    const logger = mastra?.getLogger();\n    logger?.info('üîß [HoldingsTool] Starting execution', { action: context.action });\n\n    // Get userId from context (passed from agent's resourceId/threadId)\n    const userId = context.userId || (runtimeContext as any)?.resourceId || 'default-user';\n    const HOLDINGS_KEY = `user_holdings_${userId}`;\n\n    logger?.info('üìù [HoldingsTool] User context', { userId, holdingsKey: HOLDINGS_KEY });\n\n    try {\n      // Get current holdings from agent's memory storage (PostgreSQL-backed) or in-memory cache\n      let holdings: string[] = [];\n      const memory = mastra?.memory;\n      \n      try {\n        if (memory) {\n          // Try to get holdings from persistent memory\n          const messages = await memory.getMessages({\n            resourceId: userId,\n            threadId: HOLDINGS_KEY,\n          });\n          \n          if (messages && messages.length > 0) {\n            // Get the last saved holdings state\n            const lastMessage = messages[messages.length - 1];\n            if (lastMessage.content) {\n              holdings = JSON.parse(lastMessage.content as string);\n            }\n          }\n        } else {\n          // Fallback to in-memory cache when called from API routes\n          holdings = holdingsCache.get(userId) || [];\n          logger?.info('[HoldingsTool] Using in-memory cache (no persistent memory available)');\n        }\n      } catch (e) {\n        logger?.warn('[HoldingsTool] No existing holdings found, starting fresh');\n        holdings = [];\n      }\n\n      logger?.info('üìù [HoldingsTool] Current holdings', { userId, count: holdings.length });\n\n      let message = '';\n      let success = true;\n\n      switch (context.action) {\n        case 'add':\n          if (context.ticker) {\n            const ticker = context.ticker.toUpperCase();\n            if (!holdings.includes(ticker)) {\n              holdings.push(ticker);\n              message = `Added ${ticker} to holdings`;\n            } else {\n              message = `${ticker} already in holdings`;\n            }\n          } else if (context.tickers) {\n            const newTickers = context.tickers.map(t => t.toUpperCase()).filter(t => !holdings.includes(t));\n            holdings.push(...newTickers);\n            message = `Added ${newTickers.length} ticker(s) to holdings`;\n          } else {\n            success = false;\n            message = 'No ticker provided';\n          }\n          break;\n\n        case 'remove':\n          if (context.ticker) {\n            const ticker = context.ticker.toUpperCase();\n            const index = holdings.indexOf(ticker);\n            if (index > -1) {\n              holdings.splice(index, 1);\n              message = `Removed ${ticker} from holdings`;\n            } else {\n              message = `${ticker} not found in holdings`;\n            }\n          } else {\n            success = false;\n            message = 'No ticker provided';\n          }\n          break;\n\n        case 'list':\n          message = holdings.length > 0 \n            ? `You have ${holdings.length} ticker(s) in your watchlist`\n            : 'Your watchlist is empty';\n          break;\n\n        case 'clear':\n          const count = holdings.length;\n          holdings = [];\n          message = `Cleared ${count} ticker(s) from holdings`;\n          break;\n      }\n\n      // Save updated holdings to memory (PostgreSQL-backed, per-user storage) or in-memory cache\n      try {\n        if (memory) {\n          await memory.saveMessages({\n            messages: [{\n              role: 'assistant',\n              content: JSON.stringify(holdings),\n            }],\n            resourceId: userId,\n            threadId: HOLDINGS_KEY,\n          });\n          logger?.info('üíæ [HoldingsTool] Holdings saved to database', { userId, holdingsCount: holdings.length });\n        } else {\n          // Save to in-memory cache when memory is not available\n          holdingsCache.set(userId, holdings);\n          logger?.info('üíæ [HoldingsTool] Holdings saved to in-memory cache', { userId, holdingsCount: holdings.length });\n        }\n      } catch (saveError: any) {\n        logger?.error('‚ùå [HoldingsTool] Failed to save holdings', { error: saveError.message });\n      }\n\n      logger?.info('‚úÖ [HoldingsTool] Action completed', { \n        action: context.action,\n        userId,\n        holdingsCount: holdings.length \n      });\n\n      return {\n        action: context.action,\n        success,\n        holdings,\n        message,\n      };\n    } catch (error: any) {\n      logger?.error('‚ùå [HoldingsTool] Error', { error: error.message });\n      throw new Error(`Holdings operation failed: ${error.message}`);\n    }\n  },\n});\n"],"names":[],"mappings":"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"}