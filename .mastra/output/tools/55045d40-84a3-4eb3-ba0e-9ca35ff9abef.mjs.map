{"version":3,"file":"55045d40-84a3-4eb3-ba0e-9ca35ff9abef.mjs","sources":["../../../src/mastra/tools/marketDataTool.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\nimport axios from \"axios\";\nimport { checkSubscriptionLimit } from \"../middleware/subscriptionCheck.js\";\n\n/**\n * Market Data Tool - Fetches historical price data for stocks and crypto\n * Uses free APIs: CoinGecko for crypto, Yahoo Finance for stocks\n * Implements caching to stay within free tier rate limits\n */\n\n// In-memory cache with 10-minute TTL to reduce API calls\nconst dataCache = new Map<string, { data: any; timestamp: number }>();\nconst CACHE_TTL = 10 * 60 * 1000; // 10 minutes\n\nexport const marketDataTool = createTool({\n  id: \"market-data-tool\",\n  description: \"Fetches historical price data for crypto or stock tickers. Returns OHLCV (Open, High, Low, Close, Volume) data for technical analysis.\",\n\n  inputSchema: z.object({\n    ticker: z.string().describe(\"Ticker symbol (e.g., BTC, ETH, AAPL, TSLA)\"),\n    days: z.number().optional().default(90).describe(\"Number of days of historical data (default: 90)\"),\n    type: z.enum([\"crypto\", \"stock\"]).optional().describe(\"Asset type - auto-detected if not specified\"),\n  }),\n\n  outputSchema: z.object({\n    ticker: z.string(),\n    type: z.string(),\n    currentPrice: z.number(),\n    priceChange24h: z.number(),\n    priceChangePercent24h: z.number(),\n    volume24h: z.number().optional(),\n    prices: z.array(z.object({\n      timestamp: z.number(),\n      open: z.number(),\n      high: z.number(),\n      low: z.number(),\n      close: z.number(),\n      volume: z.number(),\n    })),\n    marketCap: z.number().optional(),\n  }),\n\n  execute: async ({ context, mastra, runtimeContext }) => {\n    const logger = mastra?.getLogger();\n    logger?.info('üîß [MarketDataTool] Starting execution', { ticker: context.ticker, days: context.days });\n\n    // Extract userId from runtimeContext\n    const userId = (runtimeContext as any)?.resourceId || 'unknown';\n    \n    // Check subscription limit for searches\n    const limitCheck = await checkSubscriptionLimit(userId, 'search');\n    logger?.info('üîê [MarketDataTool] Subscription check result', { userId, allowed: limitCheck.allowed, isPremium: limitCheck.isPremium });\n    \n    if (!limitCheck.allowed) {\n      logger?.warn('‚ö†Ô∏è [MarketDataTool] Usage limit exceeded', { userId, message: limitCheck.message });\n      throw new Error(limitCheck.message || 'Daily search limit reached. Upgrade to Premium for unlimited access!');\n    }\n\n    const ticker = context.ticker.toUpperCase();\n    const days = context.days || 90;\n\n    // Auto-detect asset type with smart fallback logic\n    let assetType = context.type;\n    \n    if (!assetType) {\n      // Known crypto tickers - if matches, definitely crypto\n      const knownCryptos = ['BTC', 'ETH', 'SOL', 'USDT', 'USDC', 'BNB', 'XRP', 'ADA', 'DOGE', 'MATIC', 'DOT', 'SHIB', 'AVAX', 'UNI', 'LINK', 'ATOM', 'LTC', 'BCH', 'XLM', 'ALGO', 'ICP', 'FIL', 'NEAR', 'APT', 'ARB', 'OP', 'SUI'];\n      \n      if (knownCryptos.includes(ticker)) {\n        assetType = 'crypto';\n      } else if (ticker.includes('.')) {\n        // Stocks with exchange suffix: BRK.B, GOOGL.L\n        assetType = 'stock';\n      } else if (ticker.length > 5) {\n        // Most stocks are 1-5 chars\n        assetType = 'crypto';\n      } else {\n        // For ambiguous 1-5 character tickers, try stock first (AMD, AAPL, TSLA, etc.)\n        assetType = 'stock';\n      }\n    }\n\n    logger?.info('üìù [MarketDataTool] Initial detection', { ticker, assetType });\n\n    // Try the detected type first, then fallback to the other\n    try {\n      if (assetType === 'crypto') {\n        logger?.info('üìä [MarketDataTool] Fetching as crypto', { ticker });\n        try {\n          return await fetchCryptoDataWithRetry(ticker, days, logger);\n        } catch (cryptoError: any) {\n          logger?.warn('‚ö†Ô∏è [MarketDataTool] Crypto fetch failed, trying as stock', { \n            error: cryptoError.message \n          });\n          // Fallback to stock if crypto fails\n          return await fetchStockData(ticker, days, logger);\n        }\n      } else {\n        logger?.info('üìä [MarketDataTool] Fetching as stock', { ticker });\n        try {\n          return await fetchStockData(ticker, days, logger);\n        } catch (stockError: any) {\n          logger?.warn('‚ö†Ô∏è [MarketDataTool] Stock fetch failed, trying as crypto', { \n            error: stockError.message \n          });\n          // Fallback to crypto if stock fails\n          return await fetchCryptoDataWithRetry(ticker, days, logger);\n        }\n      }\n    } catch (error: any) {\n      logger?.error('‚ùå [MarketDataTool] All fetch attempts failed', { error: error.message });\n      throw new Error(`Failed to fetch market data for ${ticker}: Not found in crypto or stock markets`);\n    }\n  },\n});\n\n// CoinGecko mapping for top 100+ cryptocurrencies\n// CoinGecko uses lowercase coin names as IDs (bitcoin, ethereum, etc.)\nconst COINGECKO_MAP: Record<string, string> = {\n  // Top 10\n  'BTC': 'bitcoin',\n  'ETH': 'ethereum',\n  'USDT': 'tether',\n  'BNB': 'binancecoin',\n  'SOL': 'solana',\n  'USDC': 'usd-coin',\n  'XRP': 'ripple',\n  'STETH': 'staked-ether',\n  'ADA': 'cardano',\n  'DOGE': 'dogecoin',\n  \n  // Top 11-30\n  'TRX': 'tron',\n  'TON': 'the-open-network',\n  'LINK': 'chainlink',\n  'AVAX': 'avalanche-2',\n  'SHIB': 'shiba-inu',\n  'WBTC': 'wrapped-bitcoin',\n  'DOT': 'polkadot',\n  'DAI': 'dai',\n  'BCH': 'bitcoin-cash',\n  'LTC': 'litecoin',\n  'MATIC': 'matic-network',\n  'UNI': 'uniswap',\n  'LEO': 'leo-token',\n  'NEAR': 'near',\n  'PEPE': 'pepe',\n  'APT': 'aptos',\n  'ICP': 'internet-computer',\n  'WIF': 'dogwifcoin',\n  'POL': 'polygon-ecosystem-token',\n  'ETC': 'ethereum-classic',\n  \n  // Top 31-60\n  'FET': 'fetch-ai',\n  'RENDER': 'render-token',\n  'STX': 'blockstack',\n  'ARB': 'arbitrum',\n  'XLM': 'stellar',\n  'IMX': 'immutable-x',\n  'MNT': 'mantle',\n  'HBAR': 'hedera-hashgraph',\n  'ATOM': 'cosmos',\n  'CRO': 'crypto-com-chain',\n  'INJ': 'injective-protocol',\n  'FIL': 'filecoin',\n  'OP': 'optimism',\n  'VET': 'vechain',\n  'TIA': 'celestia',\n  'TAO': 'bittensor',\n  'BONK': 'bonk',\n  'SUI': 'sui',\n  'ALGO': 'algorand',\n  'XMR': 'monero',\n  'SEI': 'sei-network',\n  'THETA': 'theta-token',\n  'AAVE': 'aave',\n  'GRT': 'the-graph',\n  'RUNE': 'thorchain',\n  'MKR': 'maker',\n  'FTM': 'fantom',\n  'FLOW': 'flow',\n  'EOS': 'eos',\n  'BSV': 'bitcoin-cash-sv',\n  \n  // Top 61-100\n  'SNX': 'synthetix-network-token',\n  'SAND': 'the-sandbox',\n  'MANA': 'decentraland',\n  'AXS': 'axie-infinity',\n  'AR': 'arweave',\n  'FLOKI': 'floki',\n  'KAVA': 'kava',\n  'NEO': 'neo',\n  'XTZ': 'tezos',\n  'GALA': 'gala',\n  'ZEC': 'zcash',\n  'QNT': 'quant-network',\n  'EGLD': 'elrond-erd-2',\n  'KLAY': 'klay-token',\n  'MINA': 'mina-protocol',\n  'CHZ': 'chiliz',\n  'ROSE': 'oasis-network',\n  'CFX': 'conflux-token',\n  'CELO': 'celo',\n  'ZIL': 'zilliqa',\n  'ENJ': 'enjincoin',\n  'IOTA': 'iota',\n  'LDO': 'lido-dao',\n  'COMP': 'compound-governance-token',\n  'CRV': 'curve-dao-token',\n  '1INCH': '1inch',\n  'BAT': 'basic-attention-token',\n  'ZRX': '0x',\n  'SUSHI': 'sushi',\n  'YFI': 'yearn-finance',\n  'DASH': 'dash',\n  'WAVES': 'waves',\n  'HOT': 'holotoken',\n  'DCR': 'decred',\n  'QTUM': 'qtum',\n  'OMG': 'omisego',\n  'ICX': 'icon',\n  'ZEN': 'zencash',\n  'ONT': 'ontology',\n  'XVG': 'verge',\n  \n  // Other notable coins\n  'OSMO': 'osmosis',\n  'JUNO': 'juno-network',\n  'LUNA': 'terra-luna-2',\n  'LUNC': 'terra-luna',\n  'FTT': 'ftx-token',\n};\n\n// Retry function with exponential backoff for rate limits\nasync function fetchCryptoDataWithRetry(ticker: string, days: number, logger: any, maxRetries = 3) {\n  // Check cache first\n  const cacheKey = `crypto_${ticker}_${days}`;\n  const cached = dataCache.get(cacheKey);\n  \n  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n    logger?.info('üíæ [MarketDataTool] Using cached data', { ticker, age: Math.round((Date.now() - cached.timestamp) / 1000) + 's' });\n    return cached.data;\n  }\n\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      const data = await fetchCryptoData(ticker, days, logger);\n      \n      // Cache successful response\n      dataCache.set(cacheKey, { data, timestamp: Date.now() });\n      logger?.info('üíæ [MarketDataTool] Data cached', { ticker, ttl: CACHE_TTL / 1000 + 's' });\n      \n      return data;\n    } catch (error: any) {\n      const isRateLimit = error.response?.status === 429 || \n                         error.response?.status === 401 ||\n                         error.message?.includes('429') ||\n                         error.message?.includes('401');\n      \n      if (isRateLimit && attempt < maxRetries) {\n        const delay = Math.pow(2, attempt) * 2000; // 4s, 8s, 16s\n        logger?.warn(`‚è≥ [MarketDataTool] Rate limited/auth error, retrying in ${delay/1000}s (attempt ${attempt}/${maxRetries})`, {\n          ticker,\n          attempt\n        });\n        await new Promise(resolve => setTimeout(resolve, delay));\n      } else {\n        throw error; // Re-throw if not rate limit or max retries reached\n      }\n    }\n  }\n  throw new Error(`Failed after ${maxRetries} retries`);\n}\n\nasync function fetchCryptoData(ticker: string, days: number, logger: any) {\n  logger?.info('üìä [MarketDataTool] Fetching crypto data from CryptoCompare', { ticker, days });\n\n  // Get current price data\n  const priceUrl = `https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${ticker}&tsyms=USD`;\n  const priceResponse = await axios.get(priceUrl);\n  \n  const coinData = priceResponse.data?.RAW?.[ticker]?.USD;\n  if (!coinData) {\n    throw new Error(`Cryptocurrency ${ticker} not found on CryptoCompare`);\n  }\n\n  const currentPrice = coinData.PRICE || 0;\n  const priceChangePercent24h = coinData.CHANGEPCT24HOUR || 0;\n  const volume24h = coinData.VOLUME24HOURTO || 0;\n  const marketCap = coinData.MKTCAP || 0;\n  \n  // Get historical hourly data (limit: 2000 points free)\n  const limit = Math.min(days * 6, 2000); // 4-hour candles\n  const historyUrl = `https://min-api.cryptocompare.com/data/v2/histohour?fsym=${ticker}&tsym=USD&limit=${limit}`;\n  const historyResponse = await axios.get(historyUrl);\n\n  const histData = historyResponse.data?.Data?.Data || [];\n  \n  // Group hourly data into 4-hour candles\n  const candleSize = 4;\n  const prices = [];\n  \n  for (let i = 0; i < histData.length; i += candleSize) {\n    const candles = histData.slice(i, Math.min(i + candleSize, histData.length));\n    if (candles.length === 0) continue;\n    \n    const open = candles[0].open;\n    const close = candles[candles.length - 1].close;\n    const high = Math.max(...candles.map((c: any) => c.high));\n    const low = Math.min(...candles.map((c: any) => c.low));\n    const volume = candles.reduce((sum: number, c: any) => sum + c.volumeto, 0);\n    const timestamp = candles[0].time * 1000; // Convert to ms\n    \n    prices.push({ timestamp, open, high, low, close, volume });\n  }\n\n  logger?.info('‚úÖ [MarketDataTool] Successfully fetched crypto data from CryptoCompare', { \n    ticker,\n    dataPoints: prices.length,\n    currentPrice \n  });\n\n  return {\n    ticker,\n    type: 'crypto',\n    currentPrice,\n    priceChange24h: currentPrice * (priceChangePercent24h / 100),\n    priceChangePercent24h,\n    volume24h,\n    marketCap,\n    prices,\n  };\n}\n\n/**\n * Fallback function using Alpha Vantage API (25 calls/day free tier)\n * Used when Yahoo Finance fails or rate limits\n */\nasync function fetchStockDataAlphaVantage(ticker: string, days: number, logger: any) {\n  const apiKey = process.env.ALPHA_VANTAGE_API_KEY;\n  \n  if (!apiKey) {\n    logger?.warn('‚ö†Ô∏è [MarketDataTool] Alpha Vantage API key not configured, skipping fallback');\n    throw new Error('Alpha Vantage API key not configured');\n  }\n\n  logger?.info('üìä [MarketDataTool] Fetching stock data from Alpha Vantage (fallback)', { ticker, days });\n\n  // Alpha Vantage TIME_SERIES_DAILY for historical data\n  const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${ticker}&outputsize=full&apikey=${apiKey}`;\n  \n  const response = await axios.get(url, {\n    timeout: 15000,\n  });\n\n  // Check for rate limit or error messages\n  if (response.data['Error Message']) {\n    throw new Error(`Alpha Vantage: ${response.data['Error Message']}`);\n  }\n  \n  if (response.data['Note']) {\n    // Rate limit hit\n    throw new Error('Alpha Vantage rate limit exceeded (25 calls/day)');\n  }\n\n  const timeSeries = response.data['Time Series (Daily)'];\n  if (!timeSeries) {\n    throw new Error(`Stock ${ticker} not found on Alpha Vantage`);\n  }\n\n  // Convert time series to array format\n  const dates = Object.keys(timeSeries).slice(0, days);\n  const prices = dates.map(date => {\n    const data = timeSeries[date];\n    return {\n      timestamp: new Date(date).getTime(),\n      open: parseFloat(data['1. open']),\n      high: parseFloat(data['2. high']),\n      low: parseFloat(data['3. low']),\n      close: parseFloat(data['4. close']),\n      volume: parseFloat(data['5. volume']),\n    };\n  }).reverse(); // Oldest to newest\n\n  const latestData = timeSeries[dates[0]];\n  const previousData = timeSeries[dates[1]] || latestData;\n  \n  const currentPrice = parseFloat(latestData['4. close']);\n  const previousClose = parseFloat(previousData['4. close']);\n  const priceChange = currentPrice - previousClose;\n  const priceChangePercent = (priceChange / previousClose) * 100;\n\n  logger?.info('‚úÖ [MarketDataTool] Successfully fetched stock data from Alpha Vantage', { \n    ticker,\n    dataPoints: prices.length,\n    currentPrice \n  });\n\n  return {\n    ticker,\n    type: 'stock',\n    currentPrice,\n    priceChange24h: priceChange,\n    priceChangePercent24h: priceChangePercent,\n    prices,\n  };\n}\n\nasync function fetchStockData(ticker: string, days: number, logger: any) {\n  // Check cache first\n  const cacheKey = `stock_${ticker}_${days}`;\n  const cached = dataCache.get(cacheKey);\n  \n  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\n    logger?.info('üíæ [MarketDataTool] Using cached data', { ticker, age: Math.round((Date.now() - cached.timestamp) / 1000) + 's' });\n    return cached.data;\n  }\n\n  // Try Yahoo Finance first (free and reliable)\n  try {\n    logger?.info('üìä [MarketDataTool] Fetching stock data from Yahoo Finance', { ticker, days });\n\n    const period2 = Math.floor(Date.now() / 1000); // current timestamp\n    const period1 = period2 - (days * 24 * 60 * 60); // days ago\n    \n    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?period1=${period1}&period2=${period2}&interval=1d`;\n\n    const response = await axios.get(url, {\n      headers: {\n        'User-Agent': 'Mozilla/5.0',\n      },\n      timeout: 10000,\n    });\n\n    const result = response.data.chart.result[0];\n    if (!result) {\n      throw new Error(`Stock ${ticker} not found on Yahoo Finance`);\n    }\n\n    const quote = result.indicators.quote[0];\n    const timestamps = result.timestamp;\n\n    const prices = timestamps.map((ts: number, i: number) => ({\n      timestamp: ts * 1000,\n      open: quote.open[i] || 0,\n      high: quote.high[i] || 0,\n      low: quote.low[i] || 0,\n      close: quote.close[i] || 0,\n      volume: quote.volume[i] || 0,\n    }));\n\n    const currentPrice = result.meta.regularMarketPrice;\n    const previousClose = result.meta.chartPreviousClose;\n    const priceChange = currentPrice - previousClose;\n    const priceChangePercent = (priceChange / previousClose) * 100;\n\n    const data = {\n      ticker,\n      type: 'stock',\n      currentPrice,\n      priceChange24h: priceChange,\n      priceChangePercent24h: priceChangePercent,\n      prices,\n    };\n\n    // Cache successful response\n    dataCache.set(cacheKey, { data, timestamp: Date.now() });\n    logger?.info('üíæ [MarketDataTool] Data cached', { ticker, ttl: CACHE_TTL / 1000 + 's' });\n\n    logger?.info('‚úÖ [MarketDataTool] Successfully fetched stock data from Yahoo Finance', { \n      ticker, \n      dataPoints: prices.length,\n      currentPrice \n    });\n\n    return data;\n    \n  } catch (yahooError: any) {\n    // Fallback to Alpha Vantage if Yahoo fails\n    logger?.warn('‚ö†Ô∏è [MarketDataTool] Yahoo Finance failed, trying Alpha Vantage fallback', { \n      error: yahooError.message \n    });\n    \n    try {\n      const data = await fetchStockDataAlphaVantage(ticker, days, logger);\n      \n      // Cache successful fallback response\n      dataCache.set(cacheKey, { data, timestamp: Date.now() });\n      logger?.info('üíæ [MarketDataTool] Fallback data cached', { ticker, ttl: CACHE_TTL / 1000 + 's' });\n      \n      return data;\n    } catch (alphaError: any) {\n      logger?.error('‚ùå [MarketDataTool] Both Yahoo and Alpha Vantage failed', {\n        yahooError: yahooError.message,\n        alphaError: alphaError.message\n      });\n      \n      // Re-throw original Yahoo error\n      throw new Error(`Failed to fetch stock data for ${ticker}: ${yahooError.message}`);\n    }\n  }\n}\n"],"names":[],"mappings":"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"}