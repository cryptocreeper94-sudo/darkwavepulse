{"version":3,"file":"8c2fcc43-50a8-4f1b-bd33-f7a22adea2ac.mjs","sources":["../../../src/mastra/tools/walletEncryption.ts"],"sourcesContent":["import crypto from 'crypto';\n\n/**\n * Wallet Encryption Utilities\n * \n * Uses AES-256-GCM encryption to securely store Solana private keys in PostgreSQL.\n * The encryption key is stored as an environment variable (WALLET_ENCRYPTION_KEY).\n */\n\nconst ALGORITHM = 'aes-256-gcm';\nconst IV_LENGTH = 16;\nconst AUTH_TAG_LENGTH = 16;\nconst SALT_LENGTH = 64;\n\n/**\n * Derives a 32-byte encryption key from the master secret using PBKDF2\n */\nfunction deriveKey(masterSecret: string, salt: Buffer): Buffer {\n  return crypto.pbkdf2Sync(masterSecret, salt, 100000, 32, 'sha256');\n}\n\n/**\n * Encrypts a private key using AES-256-GCM\n * Returns: {ciphertext}:{iv}:{authTag}:{salt} (all base64-encoded)\n */\nexport function encryptPrivateKey(privateKey: string): string {\n  const masterSecret = process.env.WALLET_ENCRYPTION_KEY;\n  \n  if (!masterSecret) {\n    throw new Error('WALLET_ENCRYPTION_KEY environment variable not set');\n  }\n\n  const salt = crypto.randomBytes(SALT_LENGTH);\n  const key = deriveKey(masterSecret, salt);\n  const iv = crypto.randomBytes(IV_LENGTH);\n  \n  const cipher = crypto.createCipheriv(ALGORITHM, key, iv);\n  const encrypted = Buffer.concat([\n    cipher.update(privateKey, 'utf8'),\n    cipher.final()\n  ]);\n  \n  const authTag = cipher.getAuthTag();\n  \n  return [\n    encrypted.toString('base64'),\n    iv.toString('base64'),\n    authTag.toString('base64'),\n    salt.toString('base64')\n  ].join(':');\n}\n\n/**\n * Decrypts a private key using AES-256-GCM\n * Input format: {ciphertext}:{iv}:{authTag}:{salt} (all base64-encoded)\n */\nexport function decryptPrivateKey(encryptedData: string): string {\n  const masterSecret = process.env.WALLET_ENCRYPTION_KEY;\n  \n  if (!masterSecret) {\n    throw new Error('WALLET_ENCRYPTION_KEY environment variable not set');\n  }\n\n  const [ciphertextB64, ivB64, authTagB64, saltB64] = encryptedData.split(':');\n  \n  if (!ciphertextB64 || !ivB64 || !authTagB64 || !saltB64) {\n    throw new Error('Invalid encrypted data format');\n  }\n\n  const ciphertext = Buffer.from(ciphertextB64, 'base64');\n  const iv = Buffer.from(ivB64, 'base64');\n  const authTag = Buffer.from(authTagB64, 'base64');\n  const salt = Buffer.from(saltB64, 'base64');\n  \n  const key = deriveKey(masterSecret, salt);\n  \n  const decipher = crypto.createDecipheriv(ALGORITHM, key, iv);\n  decipher.setAuthTag(authTag);\n  \n  const decrypted = Buffer.concat([\n    decipher.update(ciphertext),\n    decipher.final()\n  ]);\n  \n  return decrypted.toString('utf8');\n}\n"],"names":[],"mappings":";;AASA,MAAM,SAAA,GAAY,aAAA;AAClB,MAAM,SAAA,GAAY,EAAA;AAElB,MAAM,WAAA,GAAc,EAAA;AAKpB,SAAS,SAAA,CAAU,cAAsB,IAAA,EAAsB;AAC7D,EAAA,OAAO,OAAO,UAAA,CAAW,YAAA,EAAc,IAAA,EAAM,GAAA,EAAQ,IAAI,QAAQ,CAAA;AACnE;AAMO,SAAS,kBAAkB,UAAA,EAA4B;AAC5D,EAAA,MAAM,YAAA,GAAe,QAAQ,GAAA,CAAI,qBAAA;AAEjC,EAAA,IAAI,CAAC,YAAA,EAAc;AACjB,IAAA,MAAM,IAAI,MAAM,oDAAoD,CAAA;AAAA,EACtE;AAEA,EAAA,MAAM,IAAA,GAAO,MAAA,CAAO,WAAA,CAAY,WAAW,CAAA;AAC3C,EAAA,MAAM,GAAA,GAAM,SAAA,CAAU,YAAA,EAAc,IAAI,CAAA;AACxC,EAAA,MAAM,EAAA,GAAK,MAAA,CAAO,WAAA,CAAY,SAAS,CAAA;AAEvC,EAAA,MAAM,MAAA,GAAS,MAAA,CAAO,cAAA,CAAe,SAAA,EAAW,KAAK,EAAE,CAAA;AACvD,EAAA,MAAM,SAAA,GAAY,OAAO,MAAA,CAAO;AAAA,IAC9B,MAAA,CAAO,MAAA,CAAO,UAAA,EAAY,MAAM,CAAA;AAAA,IAChC,OAAO,KAAA;AAAM,GACd,CAAA;AAED,EAAA,MAAM,OAAA,GAAU,OAAO,UAAA,EAAW;AAElC,EAAA,OAAO;AAAA,IACL,SAAA,CAAU,SAAS,QAAQ,CAAA;AAAA,IAC3B,EAAA,CAAG,SAAS,QAAQ,CAAA;AAAA,IACpB,OAAA,CAAQ,SAAS,QAAQ,CAAA;AAAA,IACzB,IAAA,CAAK,SAAS,QAAQ;AAAA,GACxB,CAAE,KAAK,GAAG,CAAA;AACZ;AAMO,SAAS,kBAAkB,aAAA,EAA+B;AAC/D,EAAA,MAAM,YAAA,GAAe,QAAQ,GAAA,CAAI,qBAAA;AAEjC,EAAA,IAAI,CAAC,YAAA,EAAc;AACjB,IAAA,MAAM,IAAI,MAAM,oDAAoD,CAAA;AAAA,EACtE;AAEA,EAAA,MAAM,CAAC,eAAe,KAAA,EAAO,UAAA,EAAY,OAAO,CAAA,GAAI,aAAA,CAAc,MAAM,GAAG,CAAA;AAE3E,EAAA,IAAI,CAAC,aAAA,IAAiB,CAAC,SAAS,CAAC,UAAA,IAAc,CAAC,OAAA,EAAS;AACvD,IAAA,MAAM,IAAI,MAAM,+BAA+B,CAAA;AAAA,EACjD;AAEA,EAAA,MAAM,UAAA,GAAa,MAAA,CAAO,IAAA,CAAK,aAAA,EAAe,QAAQ,CAAA;AACtD,EAAA,MAAM,EAAA,GAAK,MAAA,CAAO,IAAA,CAAK,KAAA,EAAO,QAAQ,CAAA;AACtC,EAAA,MAAM,OAAA,GAAU,MAAA,CAAO,IAAA,CAAK,UAAA,EAAY,QAAQ,CAAA;AAChD,EAAA,MAAM,IAAA,GAAO,MAAA,CAAO,IAAA,CAAK,OAAA,EAAS,QAAQ,CAAA;AAE1C,EAAA,MAAM,GAAA,GAAM,SAAA,CAAU,YAAA,EAAc,IAAI,CAAA;AAExC,EAAA,MAAM,QAAA,GAAW,MAAA,CAAO,gBAAA,CAAiB,SAAA,EAAW,KAAK,EAAE,CAAA;AAC3D,EAAA,QAAA,CAAS,WAAW,OAAO,CAAA;AAE3B,EAAA,MAAM,SAAA,GAAY,OAAO,MAAA,CAAO;AAAA,IAC9B,QAAA,CAAS,OAAO,UAAU,CAAA;AAAA,IAC1B,SAAS,KAAA;AAAM,GAChB,CAAA;AAED,EAAA,OAAO,SAAA,CAAU,SAAS,MAAM,CAAA;AAClC;;;;"}