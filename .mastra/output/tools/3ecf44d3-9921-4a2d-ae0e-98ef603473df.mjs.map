{"version":3,"file":"3ecf44d3-9921-4a2d-ae0e-98ef603473df.mjs","sources":["../../../src/mastra/tools/priceAlertTool.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\nimport { checkSubscriptionLimit } from \"../middleware/subscriptionCheck.js\";\n\nconst alertsCache = new Map<string, any[]>();\n\nexport const priceAlertTool = createTool({\n  id: \"price-alert-tool\",\n  description: \"Manage price alerts for crypto/stock assets. Create, list, and delete alerts that trigger Telegram notifications when price targets are reached.\",\n  inputSchema: z.object({\n    action: z.enum(['create', 'list', 'delete', 'check']).describe('Action to perform: create new alert, list all alerts, delete alert by ID, or check prices against alerts'),\n    userId: z.string().optional().describe('User ID for the alert'),\n    ticker: z.string().optional().describe('Asset ticker symbol (e.g., BTC, ETH, AAPL)'),\n    targetPrice: z.number().optional().describe('Target price to trigger alert'),\n    condition: z.enum(['above', 'below']).optional().describe('Alert when price goes above or below target'),\n    alertId: z.string().optional().describe('Alert ID for deletion'),\n  }),\n  outputSchema: z.object({\n    success: z.boolean(),\n    message: z.string(),\n    alerts: z.array(z.object({\n      id: z.string(),\n      ticker: z.string(),\n      targetPrice: z.number(),\n      condition: z.string(),\n      createdAt: z.string(),\n    })).optional(),\n    triggeredAlerts: z.array(z.object({\n      id: z.string(),\n      ticker: z.string(),\n      targetPrice: z.number(),\n      currentPrice: z.number(),\n      condition: z.string(),\n    })).optional(),\n  }),\n  execute: async ({ context, mastra, runtimeContext }) => {\n    const logger = mastra?.getLogger();\n    const { action, ticker, targetPrice, condition, alertId } = context;\n    const userId = context.userId || (runtimeContext as any)?.resourceId || 'default-user';\n    const ALERTS_KEY = `price_alerts_${userId}`;\n\n    logger?.info('ðŸ”” [PriceAlerts] Starting alert operation', {\n      action,\n      userId,\n      ticker,\n      targetPrice,\n      condition,\n    });\n\n    try {\n      // Use in-memory cache for alerts (simple and fast)\n      let alerts: any[] = alertsCache.get(userId) || [];\n      logger?.info('ðŸ“ [PriceAlerts] Using in-memory cache', { count: alerts.length });\n\n      // Handle different actions\n      switch (action) {\n        case 'create':\n          if (!ticker || !targetPrice || !condition) {\n            logger?.error('âŒ [PriceAlerts] Missing required fields for create');\n            return {\n              success: false,\n              message: 'Missing ticker, targetPrice, or condition',\n            };\n          }\n\n          // Check subscription limit for alert creation\n          const limitCheck = await checkSubscriptionLimit(userId, 'alert');\n          logger?.info('ðŸ” [PriceAlerts] Subscription check result', { userId, allowed: limitCheck.allowed, isPremium: limitCheck.isPremium });\n          \n          if (!limitCheck.allowed) {\n            logger?.warn('âš ï¸ [PriceAlerts] Alert limit exceeded', { userId, message: limitCheck.message });\n            return {\n              success: false,\n              message: limitCheck.message || 'Daily alert limit reached (3 alerts on free plan). Upgrade to Premium for unlimited alerts!',\n            };\n          }\n\n          const newAlert = {\n            id: `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n            ticker: ticker.toUpperCase(),\n            targetPrice,\n            condition,\n            createdAt: new Date().toISOString(),\n          };\n\n          alerts.push(newAlert);\n\n          // Save to in-memory cache\n          alertsCache.set(userId, alerts);\n\n          logger?.info('âœ… [PriceAlerts] Alert created successfully', { alert: newAlert });\n          return {\n            success: true,\n            message: `Alert created: ${ticker} ${condition} $${targetPrice}`,\n            alerts: [newAlert],\n          };\n\n        case 'list':\n          logger?.info('ðŸ“‹ [PriceAlerts] Listing all alerts', { count: alerts.length });\n          return {\n            success: true,\n            message: `Found ${alerts.length} alert(s)`,\n            alerts,\n          };\n\n        case 'delete':\n          if (!alertId) {\n            logger?.error('âŒ [PriceAlerts] Missing alert ID for deletion');\n            return {\n              success: false,\n              message: 'Missing alert ID',\n            };\n          }\n\n          const initialCount = alerts.length;\n          alerts = alerts.filter((a: any) => a.id !== alertId);\n\n          // Save updated alerts\n          alertsCache.set(userId, alerts);\n\n          if (alerts.length === initialCount) {\n            logger?.warn('âš ï¸ [PriceAlerts] Alert not found', { alertId });\n            return {\n              success: false,\n              message: 'Alert not found',\n            };\n          }\n\n          // Save updated alerts\n          if (memory) {\n            await memory.saveMessages({\n              messages: [{\n                role: 'assistant',\n                content: JSON.stringify(alerts),\n              }],\n              resourceId: userId,\n              threadId: ALERTS_KEY,\n            });\n          } else {\n            alertsCache.set(userId, alerts);\n          }\n\n          logger?.info('âœ… [PriceAlerts] Alert deleted successfully', { alertId });\n          return {\n            success: true,\n            message: 'Alert deleted successfully',\n            alerts,\n          };\n\n        case 'check':\n          // This will be called by the monitoring workflow\n          // Import marketDataTool to get current prices\n          const { marketDataTool } = await import('./marketDataTool');\n          const triggeredAlerts: any[] = [];\n\n          for (const alert of alerts) {\n            try {\n              const marketData = await marketDataTool.execute({\n                context: { ticker: alert.ticker, days: 1 },\n                mastra,\n                runtimeContext: null as any,\n              });\n\n              if (marketData && marketData.currentPrice) {\n                const currentPrice = marketData.currentPrice;\n                const shouldTrigger =\n                  (alert.condition === 'above' && currentPrice >= alert.targetPrice) ||\n                  (alert.condition === 'below' && currentPrice <= alert.targetPrice);\n\n                if (shouldTrigger) {\n                  triggeredAlerts.push({\n                    ...alert,\n                    currentPrice,\n                  });\n                  logger?.info('ðŸŽ¯ [PriceAlerts] Alert triggered!', {\n                    ticker: alert.ticker,\n                    targetPrice: alert.targetPrice,\n                    currentPrice,\n                    condition: alert.condition,\n                  });\n                }\n              }\n            } catch (error: any) {\n              logger?.error('âŒ [PriceAlerts] Error checking price', {\n                ticker: alert.ticker,\n                error: error.message,\n              });\n            }\n          }\n\n          logger?.info('âœ… [PriceAlerts] Price check complete', {\n            totalAlerts: alerts.length,\n            triggeredCount: triggeredAlerts.length,\n          });\n\n          return {\n            success: true,\n            message: `Checked ${alerts.length} alerts, ${triggeredAlerts.length} triggered`,\n            triggeredAlerts,\n          };\n\n        default:\n          logger?.error('âŒ [PriceAlerts] Invalid action', { action });\n          return {\n            success: false,\n            message: `Invalid action: ${action}`,\n          };\n      }\n    } catch (error: any) {\n      logger?.error('âŒ [PriceAlerts] Operation failed', { error: error.message });\n      return {\n        success: false,\n        message: `Alert operation failed: ${error.message}`,\n      };\n    }\n  },\n});\n"],"names":[],"mappings":"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"}