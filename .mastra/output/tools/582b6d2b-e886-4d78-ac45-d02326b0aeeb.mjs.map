{"version":3,"file":"582b6d2b-e886-4d78-ac45-d02326b0aeeb.mjs","sources":["../../../src/mastra/tools/withdrawTool.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\nimport { \n  Connection, \n  PublicKey, \n  LAMPORTS_PER_SOL, \n  Transaction, \n  SystemProgram,\n  Keypair,\n  sendAndConfirmTransaction \n} from \"@solana/web3.js\";\nimport bs58 from \"bs58\";\nimport { decryptPrivateKey } from \"./walletEncryption\";\n\n/**\n * Withdraw Tool - Allows users to withdraw SOL from bot wallet to their Phantom wallet\n * Transfers SOL from the bot-managed wallet back to user's personal wallet\n */\n\nexport const withdrawTool = createTool({\n  id: \"withdraw-tool\",\n  description: \"Withdraws SOL from the user's bot wallet to their Phantom wallet address. Specify amount and destination address.\",\n\n  inputSchema: z.object({\n    amount: z.number().describe(\"Amount of SOL to withdraw\"),\n    destinationAddress: z.string().describe(\"Phantom wallet address to send SOL to\"),\n  }),\n\n  outputSchema: z.object({\n    success: z.boolean(),\n    signature: z.string(),\n    message: z.string(),\n    amountWithdrawn: z.number(),\n  }),\n\n  execute: async ({ context, mastra, runtimeContext }) => {\n    const logger = mastra?.getLogger();\n\n    try {\n      // Get actual user ID from runtimeContext (set by workflow)\n      const userId = (runtimeContext as any)?.resourceId || context.userId || 'default-user';\n      \n      logger?.info('ðŸ”§ [WithdrawTool] Starting withdrawal', { \n        userId,\n        amount: context.amount,\n        destination: context.destinationAddress \n      });\n      \n      const WALLET_KEY = `user_wallet_${userId}`;\n\n      // Get user's wallet from database\n      const memory = mastra?.memory;\n      if (!memory) {\n        throw new Error('Memory storage not available');\n      }\n\n      const messages = await memory.getMessages({\n        resourceId: userId,\n        threadId: WALLET_KEY,\n      });\n\n      if (!messages || messages.length === 0) {\n        throw new Error('No wallet found. Create a wallet first with /wallet');\n      }\n\n      const lastMessage = messages[messages.length - 1];\n      const walletData = JSON.parse(lastMessage.content as string);\n      \n      // Decrypt and recreate keypair from stored private key\n      const decryptedPrivateKey = decryptPrivateKey(walletData.privateKey);\n      logger?.info('ðŸ”“ [WithdrawTool] Private key decrypted', { userId });\n      \n      const privateKeyArray = bs58.decode(decryptedPrivateKey);\n      const keypair = Keypair.fromSecretKey(privateKeyArray);\n\n      logger?.info('ðŸ”‘ [WithdrawTool] Loaded wallet keypair', { \n        userId,\n        fromAddress: keypair.publicKey.toBase58() \n      });\n\n      // Connect to Solana\n      const connection = new Connection('https://api.mainnet-beta.solana.com', 'confirmed');\n\n      // Validate destination address\n      let destinationPubKey: PublicKey;\n      try {\n        destinationPubKey = new PublicKey(context.destinationAddress);\n      } catch (e) {\n        throw new Error('Invalid destination wallet address');\n      }\n\n      // Check balance first\n      const balance = await connection.getBalance(keypair.publicKey);\n      const balanceSOL = balance / LAMPORTS_PER_SOL;\n\n      if (balanceSOL < context.amount) {\n        throw new Error(`Insufficient balance. You have ${balanceSOL.toFixed(4)} SOL, trying to withdraw ${context.amount} SOL`);\n      }\n\n      // Build transfer transaction\n      const amountLamports = Math.floor(context.amount * LAMPORTS_PER_SOL);\n      const transaction = new Transaction().add(\n        SystemProgram.transfer({\n          fromPubkey: keypair.publicKey,\n          toPubkey: destinationPubKey,\n          lamports: amountLamports,\n        })\n      );\n\n      logger?.info('ðŸ“¤ [WithdrawTool] Sending transaction', { \n        from: keypair.publicKey.toBase58(),\n        to: context.destinationAddress,\n        amount: context.amount \n      });\n\n      // Send and confirm transaction\n      const signature = await sendAndConfirmTransaction(\n        connection,\n        transaction,\n        [keypair],\n        {\n          commitment: 'confirmed',\n        }\n      );\n\n      logger?.info('âœ… [WithdrawTool] Withdrawal successful', { \n        userId,\n        signature,\n        amount: context.amount \n      });\n\n      return {\n        success: true,\n        signature,\n        message: `Successfully withdrew ${context.amount} SOL to ${context.destinationAddress}. Transaction: https://solscan.io/tx/${signature}`,\n        amountWithdrawn: context.amount,\n      };\n    } catch (error: any) {\n      logger?.error('âŒ [WithdrawTool] Error withdrawing', { error: error.message });\n      \n      return {\n        success: false,\n        signature: '',\n        message: `Withdrawal failed: ${error.message}`,\n        amountWithdrawn: 0,\n      };\n    }\n  },\n});\n"],"names":[],"mappings":"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"}