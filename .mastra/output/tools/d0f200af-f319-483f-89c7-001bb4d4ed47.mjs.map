{"version":3,"file":"d0f200af-f319-483f-89c7-001bb4d4ed47.mjs","sources":["../../../src/mastra/tools/botDetectionTool.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\nimport axios from \"axios\";\n\n/**\n * Bot Detection Tool\n * Analyzes token holder patterns to detect bot activity and rug risk\n */\nexport const botDetectionTool = createTool({\n  id: \"botDetection\",\n  description: `Detects bot holder activity and rug risk for crypto tokens.\n  \nAnalyzes holder distribution, wallet clustering, and liquidity patterns to calculate bot percentage and risk score.\n\nReturns:\n- Bot percentage estimate (0-100%)\n- Risk level (Safe/Low/Medium/High/Extreme)\n- Holder concentration metrics\n- Rug risk indicators`,\n\n  inputSchema: z.object({\n    tokenAddress: z.string().describe(\"Token contract address\"),\n    chain: z.string().describe(\"Blockchain (solana, ethereum, bsc, etc.)\"),\n  }),\n\n  outputSchema: z.object({\n    botPercentage: z.number().describe(\"Estimated % of holders that are bots (0-100)\"),\n    riskLevel: z.enum([\"Safe\", \"Low\", \"Medium\", \"High\", \"Extreme\"]).describe(\"Overall rug risk level\"),\n    riskColor: z.string().describe(\"Color code: green, yellow, orange, red, darkred\"),\n    holderCount: z.number().describe(\"Total unique holders\"),\n    topHolderConcentration: z.number().describe(\"% held by top 10 holders\"),\n    rugRiskIndicators: z.array(z.string()).describe(\"List of detected red flags\"),\n    confidence: z.number().describe(\"Detection confidence (0-100)\"),\n    details: z.string().describe(\"Human-readable analysis summary\"),\n  }),\n\n  execute: async ({ context, mastra }) => {\n    const logger = mastra?.getLogger();\n    const { tokenAddress, chain } = context;\n\n    logger?.info(`ü§ñ [BotDetection] Analyzing ${chain} token: ${tokenAddress}`);\n\n    try {\n      // For Solana/DEX pairs, always use Dexscreener analysis\n      // Solana addresses are base58 strings (32-44 chars), not URLs with slashes\n      const isSolanaOrDex = chain.toLowerCase() === 'solana' || chain.toLowerCase() === 'dex';\n      \n      if (isSolanaOrDex || tokenAddress.length > 20) {\n        return await analyzeDexPair(tokenAddress, chain, logger);\n      }\n\n      // For other chains, use blockchain-specific analysis (not implemented yet)\n      return await analyzeTokenHolders(tokenAddress, chain, logger);\n\n    } catch (error: any) {\n      logger?.error(`‚ùå [BotDetection] Error:`, error.message);\n      \n      // CRITICAL: Return EXTREME risk on errors for safety\n      return {\n        botPercentage: 100,\n        riskLevel: \"Extreme\" as const,\n        riskColor: \"red\",\n        holderCount: 0,\n        topHolderConcentration: 0,\n        rugRiskIndicators: [\"‚ö†Ô∏è ANALYSIS FAILED - Cannot verify safety\", \"Assume extreme risk until verified\"],\n        confidence: 0,\n        details: `Analysis unavailable: ${error.message}. DO NOT TRADE until you can verify token safety independently.`,\n      };\n    }\n  },\n});\n\n/**\n * Analyze DEX pair using Dexscreener data\n */\nasync function analyzeDexPair(pairAddress: string, chain: string, logger: any) {\n  logger?.info(`üìä [BotDetection] Fetching DEX data for ${pairAddress}`);\n\n  const response = await axios.get(`https://api.dexscreener.com/latest/dex/pairs/${chain}/${pairAddress}`, {\n    timeout: 10000,\n  });\n\n  const pair = response.data?.pair || response.data?.pairs?.[0];\n  if (!pair) {\n    throw new Error(\"Pair not found\");\n  }\n\n  // Calculate bot risk from available metrics\n  const indicators: string[] = [];\n  let botScore = 0;\n\n  // Check liquidity (low liquidity = higher rug risk)\n  const liquidity = pair.liquidity?.usd || 0;\n  if (liquidity < 1000) {\n    indicators.push(\"‚ö†Ô∏è Very low liquidity (<$1K) - extreme rug risk\");\n    botScore += 40;\n  } else if (liquidity < 10000) {\n    indicators.push(\"‚ö†Ô∏è Low liquidity (<$10K) - high rug risk\");\n    botScore += 30;\n  }\n\n  // Check if LP is locked/burned\n  if (pair.info?.websites?.length === 0 && pair.info?.socials?.length === 0) {\n    indicators.push(\"üö© No social links - possible scam\");\n    botScore += 25;\n  }\n\n  // Check age (newly created = higher risk)\n  const createdAt = pair.pairCreatedAt ? new Date(pair.pairCreatedAt).getTime() : 0;\n  const ageHours = (Date.now() - createdAt) / (1000 * 60 * 60);\n  \n  if (ageHours < 1) {\n    indicators.push(\"üö© Created <1 hour ago - extreme caution\");\n    botScore += 30;\n  } else if (ageHours < 24) {\n    indicators.push(\"‚ö†Ô∏è Created <24 hours ago\");\n    botScore += 15;\n  }\n\n  // Check transaction count (very low = suspicious)\n  const txns24h = (pair.txns?.h24?.buys || 0) + (pair.txns?.h24?.sells || 0);\n  if (txns24h < 10 && ageHours > 24) {\n    indicators.push(\"‚ö†Ô∏è Very low transaction activity\");\n    botScore += 20;\n  }\n\n  // Check price change patterns (huge pumps = bot coordination)\n  const priceChange24h = pair.priceChange?.h24 || 0;\n  if (Math.abs(priceChange24h) > 500) {\n    indicators.push(\"üö© Extreme price volatility (>500% in 24h)\");\n    botScore += 25;\n  }\n\n  // Calculate final risk level\n  const { riskLevel, riskColor } = calculateRiskLevel(botScore);\n\n  logger?.info(`‚úÖ [BotDetection] Analysis complete - Bot score: ${botScore}%, Risk: ${riskLevel}`);\n\n  return {\n    botPercentage: Math.min(botScore, 100),\n    riskLevel,\n    riskColor,\n    holderCount: 0, // Not available from Dexscreener\n    topHolderConcentration: 0,\n    rugRiskIndicators: indicators.length > 0 ? indicators : [\"‚úì No major red flags detected\"],\n    confidence: 75, // Medium confidence with public data\n    details: `Risk Analysis: ${indicators.length} warning signs detected. Bot/Rug score: ${botScore}%. ${\n      botScore < 20 ? \"Relatively safe but always DYOR.\" :\n      botScore < 50 ? \"Medium risk - trade carefully.\" :\n      botScore < 75 ? \"High risk - only trade with money you can afford to lose.\" :\n      \"EXTREME RISK - likely rug pull or bot farm. Avoid.\"\n    }`,\n  };\n}\n\n/**\n * Analyze token holders using blockchain data\n * (Future enhancement: integrate Helius/Alchemy for detailed holder data)\n */\nasync function analyzeTokenHolders(tokenAddress: string, chain: string, logger: any) {\n  logger?.info(`‚õìÔ∏è [BotDetection] Direct blockchain analysis for ${chain} not yet implemented`);\n  \n  // Placeholder for future Helius/Alchemy integration\n  return {\n    botPercentage: 0,\n    riskLevel: \"Medium\" as const,\n    riskColor: \"yellow\",\n    holderCount: 0,\n    topHolderConcentration: 0,\n    rugRiskIndicators: [\"Direct token analysis not yet available - use DEX pair analysis instead\"],\n    confidence: 0,\n    details: \"For now, use DEX pair address (chain/pairAddress) for bot detection. Full blockchain analysis coming soon with Helius integration.\",\n  };\n}\n\n/**\n * Calculate risk level from bot score\n */\nfunction calculateRiskLevel(botScore: number): { riskLevel: \"Safe\" | \"Low\" | \"Medium\" | \"High\" | \"Extreme\"; riskColor: string } {\n  if (botScore < 20) {\n    return { riskLevel: \"Safe\", riskColor: \"green\" };\n  } else if (botScore < 40) {\n    return { riskLevel: \"Low\", riskColor: \"lightgreen\" };\n  } else if (botScore < 60) {\n    return { riskLevel: \"Medium\", riskColor: \"yellow\" };\n  } else if (botScore < 80) {\n    return { riskLevel: \"High\", riskColor: \"orange\" };\n  } else {\n    return { riskLevel: \"Extreme\", riskColor: \"red\" };\n  }\n}\n"],"names":[],"mappings":"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"}