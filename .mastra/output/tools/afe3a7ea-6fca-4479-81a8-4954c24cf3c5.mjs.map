{"version":3,"file":"afe3a7ea-6fca-4479-81a8-4954c24cf3c5.mjs","sources":["../../../src/mastra/tools/chartGeneratorTool.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\n\n/**\n * Chart Generator Tool - Creates price chart with moving averages using QuickChart.io\n * Generates a visual chart showing price action with EMA 50 and EMA 200 overlaid\n */\n\nexport const chartGeneratorTool = createTool({\n  id: \"chart-generator-tool\",\n  description: \"Generates a price chart with 50-day and 200-day moving averages overlaid. Returns a chart URL that can be displayed in Telegram.\",\n\n  inputSchema: z.object({\n    ticker: z.string().describe(\"Ticker symbol\"),\n    prices: z.array(z.object({\n      timestamp: z.number(),\n      open: z.number().optional(),\n      high: z.number().optional(),\n      low: z.number().optional(),\n      close: z.number(),\n    })).describe(\"Historical price data\"),\n    ema50: z.array(z.number()).describe(\"50-day EMA values\"),\n    ema200: z.array(z.number()).describe(\"200-day EMA values\"),\n    chartType: z.enum(['line', 'candlestick']).optional().describe(\"Chart type: line or candlestick (defaults to line)\"),\n  }),\n\n  outputSchema: z.object({\n    chartUrl: z.string(),\n    success: z.boolean(),\n    message: z.string(),\n  }),\n\n  execute: async ({ context, mastra }) => {\n    const logger = mastra?.getLogger();\n    logger?.info('üîß [ChartGeneratorTool] Starting chart generation', { ticker: context.ticker });\n\n    try {\n      // Take last 90 days of data for the chart\n      const dataPoints = Math.min(90, context.prices.length);\n      const recentPrices = context.prices.slice(-dataPoints);\n      \n      // Format dates for labels\n      const labels = recentPrices.map(p => {\n        const date = new Date(p.timestamp * 1000);\n        return `${date.getMonth() + 1}/${date.getDate()}`;\n      });\n\n      // Get close prices\n      const closePrices = recentPrices.map(p => p.close);\n\n      // Align EMAs with price data (EMAs are shorter due to calculation period)\n      // Guard against edge cases where EMA arrays might be empty or too short\n      const ema50Data = context.ema50.length > 0 ? context.ema50.slice(-Math.min(dataPoints, context.ema50.length)) : [];\n      const ema200Data = context.ema200.length > 0 ? context.ema200.slice(-Math.min(dataPoints, context.ema200.length)) : [];\n\n      // Pad EMAs with nulls at the beginning to align with price data\n      const ema50PadLength = Math.max(0, dataPoints - ema50Data.length);\n      const ema200PadLength = Math.max(0, dataPoints - ema200Data.length);\n      const ema50Padded = [...Array(ema50PadLength).fill(null), ...ema50Data];\n      const ema200Padded = [...Array(ema200PadLength).fill(null), ...ema200Data];\n\n      const chartType = context.chartType || 'line';\n      let chartConfig: any;\n\n      if (chartType === 'candlestick') {\n        // Prepare candlestick data (OHLC format)\n        const candlestickData = recentPrices.map(p => ({\n          x: p.timestamp * 1000,\n          o: p.open || p.close,\n          h: p.high || p.close,\n          l: p.low || p.close,\n          c: p.close,\n        }));\n\n        // Create candlestick chart configuration\n        chartConfig = {\n          type: 'candlestick',\n          data: {\n            datasets: [\n              {\n                label: context.ticker,\n                data: candlestickData,\n                borderColor: {\n                  up: 'rgb(75, 192, 128)',\n                  down: 'rgb(239, 68, 68)',\n                  unchanged: 'rgb(156, 163, 175)',\n                },\n                backgroundColor: {\n                  up: 'rgba(75, 192, 128, 0.5)',\n                  down: 'rgba(239, 68, 68, 0.5)',\n                  unchanged: 'rgba(156, 163, 175, 0.5)',\n                },\n              },\n            ],\n          },\n          options: {\n            plugins: {\n              title: {\n                display: true,\n                text: `${context.ticker} - Candlestick Chart`,\n                font: { size: 16 },\n              },\n              legend: { display: false },\n            },\n            scales: {\n              x: {\n                type: 'time',\n                time: { unit: 'day' },\n              },\n              y: {\n                ticks: {\n                  callback: function(value: any) {\n                    return '$' + value.toFixed(2);\n                  },\n                },\n              },\n            },\n          },\n        };\n      } else {\n        // Create line chart configuration (default)\n        chartConfig = {\n          type: 'line',\n          data: {\n            labels: labels,\n            datasets: [\n              {\n                label: 'Price',\n                data: closePrices,\n                borderColor: 'rgb(75, 192, 192)',\n                backgroundColor: 'rgba(75, 192, 192, 0.1)',\n                borderWidth: 2,\n                fill: true,\n                tension: 0.1,\n              },\n              {\n                label: 'EMA 50',\n                data: ema50Padded,\n                borderColor: 'rgb(255, 159, 64)',\n                borderWidth: 2,\n                fill: false,\n                tension: 0.1,\n                pointRadius: 0,\n              },\n              {\n                label: 'EMA 200',\n                data: ema200Padded,\n                borderColor: 'rgb(153, 102, 255)',\n                borderWidth: 2,\n                fill: false,\n                tension: 0.1,\n                pointRadius: 0,\n              },\n            ],\n          },\n          options: {\n          plugins: {\n            title: {\n              display: true,\n              text: `${context.ticker} - Price with Moving Averages`,\n              font: {\n                size: 16,\n              },\n            },\n            legend: {\n              display: true,\n              position: 'bottom',\n            },\n          },\n          scales: {\n            y: {\n              ticks: {\n                callback: function(value: any) {\n                  return '$' + value.toFixed(2);\n                },\n              },\n            },\n          },\n          },\n        };\n      }\n\n      // Encode chart config for QuickChart.io\n      const chartJson = JSON.stringify(chartConfig);\n      const encodedChart = encodeURIComponent(chartJson);\n\n      // Generate QuickChart.io URL (free service, no API key needed)\n      // For candlestick charts, add the financial chart plugin\n      const pluginParam = chartType === 'candlestick' ? '&plugins=chartjs-chart-financial' : '';\n      const chartUrl = `https://quickchart.io/chart?width=800&height=400&chart=${encodedChart}${pluginParam}`;\n\n      logger?.info('‚úÖ [ChartGeneratorTool] Chart generated successfully', { \n        ticker: context.ticker,\n        dataPoints \n      });\n\n      return {\n        chartUrl,\n        success: true,\n        message: `Chart generated for ${context.ticker} with ${dataPoints} days of data`,\n      };\n    } catch (error: any) {\n      logger?.error('‚ùå [ChartGeneratorTool] Error generating chart', { error: error.message });\n      \n      // Return a fallback - don't fail the entire analysis\n      return {\n        chartUrl: '',\n        success: false,\n        message: `Chart generation failed: ${error.message}`,\n      };\n    }\n  },\n});\n"],"names":[],"mappings":"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"}