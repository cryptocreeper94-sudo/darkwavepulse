{"version":3,"file":"6e27ba7a-5323-42a0-9142-f4e1c393fbe6.mjs","sources":["../../../src/mastra/tools/walletGeneratorTool.ts"],"sourcesContent":["import { createTool } from \"@mastra/core/tools\";\nimport { z } from \"zod\";\nimport { Keypair } from \"@solana/web3.js\";\nimport bs58 from \"bs58\";\nimport { encryptPrivateKey } from \"./walletEncryption\";\n\n/**\n * Wallet Generator Tool - Creates new Solana wallets for users\n * Each user gets a unique wallet address to fund from their Phantom wallet\n */\n\nexport const walletGeneratorTool = createTool({\n  id: \"wallet-generator-tool\",\n  description: \"Generates a new Solana wallet for the user. Returns the wallet address (public key) that users can send SOL to from their Phantom wallet. The bot manages this wallet for trading.\",\n\n  inputSchema: z.object({}),\n\n  outputSchema: z.object({\n    walletAddress: z.string(),\n    success: z.boolean(),\n    message: z.string(),\n    isNewWallet: z.boolean(),\n  }),\n\n  execute: async ({ context, mastra }) => {\n    const logger = mastra?.getLogger();\n\n    try {\n      // Get userId from context (passed from workflow)\n      const userId = (context as any).userId || 'default-user';\n      \n      logger?.info('üîß [WalletGeneratorTool] Starting wallet retrieval/generation', { userId });\n      \n      const WALLET_KEY = `user_wallet_${userId}`;\n\n      // Check if user already has a wallet\n      let existingWallet: { publicKey: string; privateKey: string } | null = null;\n      \n      try {\n        const memory = mastra?.memory;\n        if (memory) {\n          const messages = await memory.getMessages({\n            resourceId: userId,\n            threadId: WALLET_KEY,\n          });\n          \n          if (messages && messages.length > 0) {\n            const lastMessage = messages[messages.length - 1];\n            if (lastMessage.content) {\n              existingWallet = JSON.parse(lastMessage.content as string);\n              logger?.info('‚úÖ [WalletGeneratorTool] Found existing wallet', { \n                userId,\n                walletAddress: existingWallet.publicKey \n              });\n              \n              return {\n                walletAddress: existingWallet.publicKey,\n                success: true,\n                message: `Your existing wallet address: ${existingWallet.publicKey}`,\n                isNewWallet: false,\n              };\n            }\n          }\n        }\n      } catch (e) {\n        logger?.info('[WalletGeneratorTool] No existing wallet found, creating new one');\n      }\n\n      // Generate new Solana wallet\n      const keypair = Keypair.generate();\n      const publicKey = keypair.publicKey.toBase58();\n      const privateKey = bs58.encode(keypair.secretKey);\n\n      logger?.info('üîë [WalletGeneratorTool] Generated new wallet', { \n        userId,\n        walletAddress: publicKey \n      });\n\n      // Encrypt private key before storage\n      const encryptedPrivateKey = encryptPrivateKey(privateKey);\n      logger?.info('üîí [WalletGeneratorTool] Private key encrypted', { userId });\n\n      // Save wallet to database (encrypted storage via PostgreSQL)\n      const memory = mastra?.memory;\n      if (memory) {\n        await memory.saveMessages({\n          messages: [{\n            role: 'system',\n            content: JSON.stringify({\n              publicKey,\n              privateKey: encryptedPrivateKey, // Encrypted using AES-256-GCM\n              createdAt: new Date().toISOString(),\n            }),\n          }],\n          resourceId: userId,\n          threadId: WALLET_KEY,\n        });\n        logger?.info('üíæ [WalletGeneratorTool] Saved encrypted wallet to database', { userId });\n      }\n\n      logger?.info('‚úÖ [WalletGeneratorTool] Wallet generation complete', { \n        userId,\n        walletAddress: publicKey \n      });\n\n      return {\n        walletAddress: publicKey,\n        success: true,\n        message: `New wallet created! Send SOL from your Phantom wallet to: ${publicKey}`,\n        isNewWallet: true,\n      };\n    } catch (error: any) {\n      logger?.error('‚ùå [WalletGeneratorTool] Error generating wallet', { error: error.message });\n      \n      return {\n        walletAddress: '',\n        success: false,\n        message: `Failed to generate wallet: ${error.message}`,\n        isNewWallet: false,\n      };\n    }\n  },\n});\n"],"names":["memory","bs58"],"mappings":"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"}