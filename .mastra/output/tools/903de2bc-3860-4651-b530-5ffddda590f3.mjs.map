{"version":3,"file":"903de2bc-3860-4651-b530-5ffddda590f3.mjs","sources":["../../../src/mastra/tools/jupiterLimitOrderTool.ts"],"sourcesContent":["import { createTool } from '@mastra/core/tools';\nimport { z } from 'zod';\nimport { walletCache, ordersCache, settingsCache } from './sharedCaches';\n\n/**\n * Jupiter Limit Order Tool - Places limit orders on Jupiter DEX\n * Supports buy/sell orders with target prices and auto-execution\n */\n\nexport const jupiterLimitOrderTool = createTool({\n  id: 'jupiter-limit-order',\n  description: `Creates limit orders for token trading via Jupiter DEX. \n  Use this when the user wants to:\n  - Buy a token when price reaches a specific level\n  - Sell a token when price hits a target\n  - Set auto-sell targets\n  - View or cancel active orders\n  \n  Example: \"Buy BONK at $0.002\" or \"Sell JUP at $1.50\"`,\n  inputSchema: z.object({\n    action: z.enum(['create', 'list', 'cancel']).describe('Action to perform'),\n    userId: z.string().describe('User ID from Telegram'),\n    orderType: z.enum(['buy', 'sell']).optional().describe('Order type'),\n    ticker: z.string().optional().describe('Token symbol (e.g., BONK, JUP)'),\n    contractAddress: z.string().optional().describe('Token contract address (optional, for specific tokens)'),\n    targetPrice: z.number().optional().describe('Trigger price for the order'),\n    amount: z.number().optional().describe('Amount in SOL (for buy) or tokens (for sell)'),\n    orderId: z.string().optional().describe('Order ID to cancel'),\n  }),\n  outputSchema: z.object({\n    success: z.boolean(),\n    message: z.string(),\n    orders: z.array(z.object({\n      id: z.string(),\n      type: z.string(),\n      ticker: z.string(),\n      targetPrice: z.number(),\n      amount: z.number(),\n      status: z.string(),\n      createdAt: z.string(),\n    })).optional(),\n  }),\n  execute: async ({ context, mastra, runtimeContext }) => {\n    const logger = mastra?.getLogger();\n    const { action, orderType, ticker, targetPrice, amount, orderId } = context;\n    const userId = context.userId || (runtimeContext as any)?.resourceId || 'default-user';\n    const ORDERS_KEY = `limit_orders_${userId}`;\n    const WALLET_KEY = `user_wallet_${userId}`;\n    const SETTINGS_KEY = `user_settings_${userId}`;\n\n    logger?.info('üìä [JupiterLimitOrder] Starting limit order operation', {\n      action,\n      userId,\n      orderType,\n      ticker,\n    });\n\n    try {\n      // Check if wallet is connected\n      const walletData = walletCache.get(userId);\n      const walletAddress = walletData?.address || null;\n\n      if (!walletAddress) {\n        return {\n          success: false,\n          message: '‚ö†Ô∏è No wallet connected. Connect your wallet in the Mini App first.',\n        };\n      }\n\n      // Get current orders from cache\n      let orders: any[] = ordersCache.get(userId) || [];\n\n      if (action === 'list') {\n        logger?.info('üìã [JupiterLimitOrder] Listing orders', { count: orders.length });\n\n        if (orders.length === 0) {\n          return {\n            success: true,\n            message: 'üìã No active limit orders.\\n\\nUse commands like \"buy BONK at 0.002\" to create orders.',\n            orders: [],\n          };\n        }\n\n        let message = `üìã Active Limit Orders (${orders.length}):\\n\\n`;\n        orders.forEach((order, idx) => {\n          const typeEmoji = order.type === 'buy' ? 'üü¢' : 'üî¥';\n          message += `${idx + 1}. ${typeEmoji} ${order.type.toUpperCase()} ${order.ticker}\\n`;\n          message += `   Target: $${order.targetPrice}\\n`;\n          message += `   Amount: ${order.amount} ${order.type === 'buy' ? 'SOL' : order.ticker}\\n`;\n          message += `   Status: ${order.status}\\n`;\n          message += `   Created: ${new Date(order.createdAt).toLocaleString()}\\n\\n`;\n        });\n\n        return {\n          success: true,\n          message,\n          orders,\n        };\n      }\n\n      if (action === 'cancel') {\n        if (!orderId && orders.length > 0) {\n          return {\n            success: false,\n            message: 'Please specify which order to cancel (by number or ID)',\n          };\n        }\n\n        // Find order by ID or index\n        let orderIndex = -1;\n        if (orderId) {\n          orderIndex = orders.findIndex(o => o.id === orderId || o.id === `order_${orderId}`);\n          if (orderIndex === -1 && !isNaN(parseInt(orderId))) {\n            orderIndex = parseInt(orderId) - 1; // Allow numeric index (1-based)\n          }\n        }\n\n        if (orderIndex === -1 || orderIndex >= orders.length) {\n          return {\n            success: false,\n            message: 'Order not found',\n          };\n        }\n\n        const cancelledOrder = orders.splice(orderIndex, 1)[0];\n\n        // Save updated orders to cache\n        ordersCache.set(userId, orders);\n\n        logger?.info('‚úÖ [JupiterLimitOrder] Order cancelled', { orderId: cancelledOrder.id });\n\n        return {\n          success: true,\n          message: `‚úÖ Cancelled ${cancelledOrder.type.toUpperCase()} order for ${cancelledOrder.ticker} at $${cancelledOrder.targetPrice}`,\n          orders,\n        };\n      }\n\n      if (action === 'create') {\n        if (!orderType || !ticker || !targetPrice || !amount) {\n          return {\n            success: false,\n            message: 'Missing required fields: orderType, ticker, targetPrice, amount',\n          };\n        }\n\n        // Get user settings to check auto-execute preference\n        const settings = settingsCache.get(userId) || {};\n        const autoExecute = settings?.autoExecute || false;\n\n        // Create new order\n        const newOrder = {\n          id: `order_${Date.now()}`,\n          type: orderType,\n          ticker: ticker.toUpperCase(),\n          targetPrice,\n          amount,\n          status: autoExecute ? 'active (auto-execute ON)' : 'active (manual approval required)',\n          createdAt: new Date().toISOString(),\n          walletAddress,\n          autoExecute,\n        };\n\n        orders.push(newOrder);\n\n        // Save orders to cache\n        ordersCache.set(userId, orders);\n\n        logger?.info('‚úÖ [JupiterLimitOrder] Order created', {\n          orderId: newOrder.id,\n          type: orderType,\n          ticker,\n        });\n\n        let message = `‚úÖ Limit Order Created\\n\\n`;\n        message += `${orderType === 'buy' ? 'üü¢' : 'üî¥'} ${orderType.toUpperCase()} ${ticker.toUpperCase()}\\n`;\n        message += `üí∞ Amount: ${amount} ${orderType === 'buy' ? 'SOL' : ticker.toUpperCase()}\\n`;\n        message += `üéØ Target Price: $${targetPrice}\\n`;\n        message += `üìç Wallet: ${walletAddress.slice(0, 8)}...${walletAddress.slice(-4)}\\n\\n`;\n\n        if (autoExecute) {\n          message += `‚ö° AUTO-EXECUTE ENABLED - Order will execute automatically when price hits target\\n\\n`;\n          message += `‚ö†Ô∏è NOTE: Actual execution requires Jupiter integration (currently in test mode)`;\n        } else {\n          message += `‚ö†Ô∏è AUTO-EXECUTE DISABLED - You'll receive a notification when price hits target, but must approve manually\\n\\n`;\n          message += `Enable auto-execute with \"enable auto trading\"`;\n        }\n\n        return {\n          success: true,\n          message,\n          orders: [newOrder],\n        };\n      }\n\n      return {\n        success: false,\n        message: 'Unknown action',\n      };\n    } catch (error) {\n      logger?.error('‚ùå [JupiterLimitOrder] Error:', error);\n      return {\n        success: false,\n        message: `Error: ${error instanceof Error ? error.message : 'Unknown error'}`,\n      };\n    }\n  },\n});\n"],"names":[],"mappings":"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"}