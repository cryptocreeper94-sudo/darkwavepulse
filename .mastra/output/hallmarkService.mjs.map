{"version":3,"file":"hallmarkService.mjs","sources":["../../src/services/hallmarkService.ts"],"sourcesContent":["import { createHash, randomBytes } from 'crypto';\nimport { db } from '../db/client.js';\nimport { hallmarkProfiles, hallmarkMints, auditEvents } from '../db/schema.js';\nimport { eq, desc, and, sql } from 'drizzle-orm';\nimport { auditTrailService, AUDIT_EVENT_TYPES, EVENT_CATEGORIES } from './auditTrailService.js';\nimport { darkwaveChainClient } from './darkwaveChainClient.js';\n\ninterface HallmarkProfile {\n  userId: string;\n  avatarType: string;\n  avatarId: string | null;\n  customAvatarUrl: string | null;\n  currentSerial: number;\n  preferredTemplate: string | null;\n  displayName: string | null;\n  bio: string | null;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\ninterface HallmarkMint {\n  id: string;\n  userId: string;\n  serialNumber: string;\n  avatarSnapshot: string | null;\n  templateUsed: string;\n  payloadHash: string;\n  auditEventIds: string | null;\n  memoSignature: string | null;\n  heliusTxId: string | null;\n  artworkUrl: string | null;\n  metadataUri: string | null;\n  priceUsd: string;\n  paymentProvider: string | null;\n  paymentId: string | null;\n  status: string;\n  createdAt: Date;\n  paidAt: Date | null;\n  mintedAt: Date | null;\n}\n\nclass HallmarkService {\n  private readonly HALLMARK_PRICE_USD = '1.99';\n  \n  /**\n   * Generate a unique Hallmark ID\n   */\n  private generateHallmarkId(): string {\n    const timestamp = Date.now().toString(36);\n    const random = randomBytes(8).toString('hex');\n    return `hm_${timestamp}_${random}`;\n  }\n  \n  /**\n   * Generate a unique serial number for a user\n   * Format: HW-{USERID}-{0001} where USERID is the sanitized user ID\n   */\n  private generateSerialNumber(userId: string, serial: number): string {\n    // Sanitize user ID: keep alphanumeric only, uppercase, max 12 chars\n    const cleanUserId = userId.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().substring(0, 12);\n    return `HW-${cleanUserId}-${serial.toString().padStart(4, '0')}`;\n  }\n  \n  /**\n   * Get or create a user's Hallmark profile\n   */\n  async getOrCreateProfile(userId: string, displayName?: string): Promise<HallmarkProfile> {\n    const [existing] = await db.select()\n      .from(hallmarkProfiles)\n      .where(eq(hallmarkProfiles.userId, userId))\n      .limit(1);\n    \n    if (existing) {\n      return existing as HallmarkProfile;\n    }\n    \n    // Create new profile\n    const [profile] = await db.insert(hallmarkProfiles).values({\n      userId,\n      avatarType: 'agent',\n      currentSerial: 0,\n      preferredTemplate: 'classic',\n      displayName: displayName || null,\n    }).returning();\n    \n    return profile as HallmarkProfile;\n  }\n  \n  /**\n   * Update a user's Hallmark profile\n   */\n  async updateProfile(userId: string, updates: Partial<{\n    avatarType: string;\n    avatarId: string;\n    customAvatarUrl: string;\n    preferredTemplate: string;\n    displayName: string;\n    bio: string;\n  }>): Promise<HallmarkProfile> {\n    const [profile] = await db.update(hallmarkProfiles)\n      .set({\n        ...updates,\n        updatedAt: new Date(),\n      })\n      .where(eq(hallmarkProfiles.userId, userId))\n      .returning();\n    \n    return profile as HallmarkProfile;\n  }\n  \n  /**\n   * Create a draft Hallmark (before payment)\n   */\n  async createDraftHallmark(userId: string, options?: {\n    avatarType?: string;\n    avatarId?: string;\n    template?: string;\n  }): Promise<HallmarkMint> {\n    // Get or create profile\n    const profile = await this.getOrCreateProfile(userId);\n    \n    // Get recent audit events for this user\n    const recentEvents = await db.select()\n      .from(auditEvents)\n      .where(eq(auditEvents.userId, userId))\n      .orderBy(desc(auditEvents.createdAt))\n      .limit(10);\n    \n    // Increment serial\n    const newSerial = profile.currentSerial + 1;\n    const serialNumber = this.generateSerialNumber(userId, newSerial);\n    \n    // Build payload for hashing\n    const payload = {\n      userId,\n      serialNumber,\n      avatarType: options?.avatarType || profile.avatarType,\n      avatarId: options?.avatarId || profile.avatarId,\n      template: options?.template || profile.preferredTemplate || 'classic',\n      recentEventHashes: recentEvents.map(e => e.payloadHash),\n      createdAt: new Date().toISOString(),\n    };\n    \n    const payloadHash = createHash('sha256')\n      .update(JSON.stringify(payload))\n      .digest('hex');\n    \n    // Create the draft mint\n    const hallmarkId = this.generateHallmarkId();\n    const [mint] = await db.insert(hallmarkMints).values({\n      id: hallmarkId,\n      userId,\n      serialNumber,\n      avatarSnapshot: JSON.stringify({\n        type: options?.avatarType || profile.avatarType,\n        id: options?.avatarId || profile.avatarId,\n      }),\n      templateUsed: options?.template || profile.preferredTemplate || 'classic',\n      payloadHash,\n      auditEventIds: JSON.stringify(recentEvents.map(e => e.id)),\n      priceUsd: this.HALLMARK_PRICE_USD,\n      status: 'draft',\n    }).returning();\n    \n    console.log(`üìã [Hallmark] Draft created: ${serialNumber}`, { hallmarkId, payloadHash: payloadHash.substring(0, 16) + '...' });\n    \n    return mint as HallmarkMint;\n  }\n  \n  /**\n   * Process payment for a Hallmark\n   */\n  async processPayment(hallmarkId: string, paymentInfo: {\n    provider: string;\n    paymentId: string;\n  }): Promise<HallmarkMint> {\n    // Get the hallmark\n    const [hallmark] = await db.select()\n      .from(hallmarkMints)\n      .where(eq(hallmarkMints.id, hallmarkId))\n      .limit(1);\n    \n    if (!hallmark) {\n      throw new Error('Hallmark not found');\n    }\n    \n    if (hallmark.status !== 'draft') {\n      throw new Error('Hallmark is not in draft status');\n    }\n    \n    // Update to paid status\n    const [updated] = await db.update(hallmarkMints)\n      .set({\n        paymentProvider: paymentInfo.provider,\n        paymentId: paymentInfo.paymentId,\n        status: 'paid',\n        paidAt: new Date(),\n      })\n      .where(eq(hallmarkMints.id, hallmarkId))\n      .returning();\n    \n    // Update user's serial counter\n    const [profile] = await db.select()\n      .from(hallmarkProfiles)\n      .where(eq(hallmarkProfiles.userId, hallmark.userId))\n      .limit(1);\n    \n    if (profile) {\n      await db.update(hallmarkProfiles)\n        .set({\n          currentSerial: profile.currentSerial + 1,\n          updatedAt: new Date(),\n        })\n        .where(eq(hallmarkProfiles.userId, hallmark.userId));\n    }\n    \n    // Log the purchase event\n    await auditTrailService.logEvent({\n      userId: hallmark.userId,\n      eventType: AUDIT_EVENT_TYPES.HALLMARK_PURCHASED,\n      category: EVENT_CATEGORIES.HALLMARK,\n      data: {\n        hallmarkId,\n        serialNumber: hallmark.serialNumber,\n        amount: this.HALLMARK_PRICE_USD,\n        provider: paymentInfo.provider,\n      },\n    });\n    \n    console.log(`üí∞ [Hallmark] Payment processed: ${hallmark.serialNumber}`);\n    \n    // Queue for minting\n    this.queueForMinting(hallmarkId);\n    \n    return updated as HallmarkMint;\n  }\n  \n  /**\n   * Queue a hallmark for on-chain minting\n   */\n  private async queueForMinting(hallmarkId: string): Promise<void> {\n    // Check if wallet is configured\n    const walletConfigured = await auditTrailService.isWalletConfigured();\n    \n    if (!walletConfigured) {\n      console.log(`‚è≥ [Hallmark] ${hallmarkId} queued for minting - waiting for wallet`);\n      return;\n    }\n    \n    // Will be implemented with full Helius/Metaplex integration\n    this.processHallmarkMint(hallmarkId);\n  }\n  \n  /**\n   * Process the actual NFT minting via DarkWave Chain\n   */\n  private async processHallmarkMint(hallmarkId: string): Promise<void> {\n    try {\n      const hallmark = await this.getHallmark(hallmarkId);\n      if (!hallmark) {\n        console.error(`‚ùå [Hallmark] Hallmark not found: ${hallmarkId}`);\n        return;\n      }\n\n      // Submit to DarkWave Chain for on-chain hallmark generation\n      const result = await darkwaveChainClient.generateHallmark({\n        productType: 'pulse_hallmark',\n        productId: hallmarkId,\n        metadata: {\n          serialNumber: hallmark.serialNumber,\n          template: hallmark.templateUsed,\n          payloadHash: hallmark.payloadHash,\n          userId: hallmark.userId,\n        },\n      });\n\n      if (result.id) {\n        await db.update(hallmarkMints)\n          .set({\n            memoSignature: result.txHash || result.id,\n            metadataUri: result.verificationUrl,\n            status: 'minted',\n            mintedAt: new Date(),\n          })\n          .where(eq(hallmarkMints.id, hallmarkId));\n\n        console.log(`üé® [Hallmark] ${hallmarkId} minted on DarkWave Chain: ${result.id}`);\n      }\n    } catch (error: any) {\n      console.warn(`‚ö†Ô∏è [Hallmark] DarkWave Chain minting unavailable: ${error.message}`);\n    }\n  }\n  \n  /**\n   * Verify a hallmark on DarkWave Chain\n   */\n  async verifyOnChain(hallmarkId: string): Promise<{\n    valid: boolean;\n    onChain: boolean;\n    blockNumber?: number;\n    verificationUrl?: string;\n  }> {\n    try {\n      const result = await darkwaveChainClient.verifyHallmark(hallmarkId);\n      return {\n        valid: result.valid,\n        onChain: result.onChain,\n        blockNumber: result.blockNumber,\n        verificationUrl: result.hallmark?.verificationUrl,\n      };\n    } catch (error: any) {\n      return { valid: false, onChain: false };\n    }\n  }\n  \n  /**\n   * Get a user's Hallmark collection\n   */\n  async getUserHallmarks(userId: string): Promise<HallmarkMint[]> {\n    const hallmarks = await db.select()\n      .from(hallmarkMints)\n      .where(and(\n        eq(hallmarkMints.userId, userId),\n        sql`${hallmarkMints.status} != 'draft'`\n      ))\n      .orderBy(desc(hallmarkMints.createdAt));\n    \n    return hallmarks as HallmarkMint[];\n  }\n  \n  /**\n   * Get a specific Hallmark by ID\n   */\n  async getHallmark(hallmarkId: string): Promise<HallmarkMint | null> {\n    const [hallmark] = await db.select()\n      .from(hallmarkMints)\n      .where(eq(hallmarkMints.id, hallmarkId))\n      .limit(1);\n    \n    return hallmark as HallmarkMint | null;\n  }\n  \n  /**\n   * Get Hallmark by serial number\n   */\n  async getHallmarkBySerial(serialNumber: string): Promise<HallmarkMint | null> {\n    const [hallmark] = await db.select()\n      .from(hallmarkMints)\n      .where(eq(hallmarkMints.serialNumber, serialNumber))\n      .limit(1);\n    \n    return hallmark as HallmarkMint | null;\n  }\n  \n  /**\n   * Verify a Hallmark's authenticity\n   */\n  async verifyHallmark(serialNumber: string): Promise<{\n    valid: boolean;\n    hallmark?: HallmarkMint;\n    onChain?: boolean;\n  }> {\n    const hallmark = await this.getHallmarkBySerial(serialNumber);\n    \n    if (!hallmark) {\n      return { valid: false };\n    }\n    \n    return {\n      valid: true,\n      hallmark,\n      onChain: !!hallmark.memoSignature,\n    };\n  }\n  \n  /**\n   * Get statistics for admin dashboard\n   */\n  async getStats(): Promise<{\n    totalHallmarks: number;\n    pendingMints: number;\n    mintedHallmarks: number;\n    totalRevenue: number;\n    hallmarksByTemplate: Record<string, number>;\n  }> {\n    const allHallmarks = await db.select()\n      .from(hallmarkMints)\n      .where(sql`${hallmarkMints.status} != 'draft'`);\n    \n    const stats = {\n      totalHallmarks: allHallmarks.length,\n      pendingMints: allHallmarks.filter(h => h.status === 'paid').length,\n      mintedHallmarks: allHallmarks.filter(h => h.status === 'minted').length,\n      totalRevenue: allHallmarks.filter(h => h.paidAt).length * parseFloat(this.HALLMARK_PRICE_USD),\n      hallmarksByTemplate: {} as Record<string, number>,\n    };\n    \n    allHallmarks.forEach(h => {\n      const template = h.templateUsed;\n      stats.hallmarksByTemplate[template] = (stats.hallmarksByTemplate[template] || 0) + 1;\n    });\n    \n    return stats;\n  }\n}\n\n// Export singleton instance\nexport const hallmarkService = new HallmarkService();\n"],"names":[],"mappings":"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"}